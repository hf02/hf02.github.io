var le=Object.defineProperty,ce=Object.defineProperties;var ue=Object.getOwnPropertyDescriptors;var Mt=Object.getOwnPropertySymbols;var de=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var Ot=(s,t,e)=>t in s?le(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,P=(s,t)=>{for(var e in t||(t={}))de.call(t,e)&&Ot(s,e,t[e]);if(Mt)for(var e of Mt(t))_e.call(t,e)&&Ot(s,e,t[e]);return s},Pt=(s,t)=>ce(s,ue(t));import{O as me,P as At,S as Z,i as $,s as Q,e as D,t as tt,c as C,a as E,g as et,d as g,b as S,f as z,L as y,h as dt,j,l as N,K as R,Q as It,R as _t,u as zt,T as jt,U as pe,V as H,W as B,X as fe,Y as ge,Z as xe,_ as be,$ as we,a0 as ye,a1 as ve,a2 as ke,a3 as Te,p as O,v as st,w as it,x as nt,a4 as Se,n as F,A as rt,m as Nt,o as Rt,I as De,J as Bt,M as Ft,N as Vt,a5 as Ut,k as Wt,a6 as Lt,a7 as qt,E as Ce}from"../chunks/vendor-7952ea8e.js";import{L as Ee}from"../chunks/LoadingScreen-69ccc074.js";const K=9;function Me(){function s(e,i=2){for(e=e.toString();e.length<i;)e=`0${e}`;return e}const t=new Date;return`${s(t.getHours())}:${s(t.getMinutes())}:${s(t.getSeconds())}.${s(t.getMilliseconds(),3)}`}function Oe(s,t,e){return s.padEnd(e,t).slice(0,e)}class W extends me{}function Gt(s){let t,e,i,n;return{c(){t=D("div"),e=tt("! "),i=tt(s[7]),this.h()},l(r){t=C(r,"DIV",{class:!0});var a=E(t);e=et(a,"! "),i=et(a,s[7]),a.forEach(g),this.h()},h(){S(t,"class",n="unstable "+(s[5]?"cooldown":"")+" svelte-1cip8ko")},m(r,a){z(r,t,a),y(t,e),y(t,i)},p(r,a){a&128&&dt(i,r[7]),a&32&&n!==(n="unstable "+(r[5]?"cooldown":"")+" svelte-1cip8ko")&&S(t,"class",n)},d(r){r&&g(t)}}}function Pe(s){let t,e,i,n,r,a=(s[1]?s[3]:`${s[4]}
${s[3]}`)+"",h,d,l,m,p=(s[6]===!0||s[5]===!0)&&Gt(s);return{c(){t=D("div"),e=D("div"),i=D("div"),n=j(),r=D("div"),h=tt(a),d=j(),l=D("canvas"),m=j(),p&&p.c(),this.h()},l(c){t=C(c,"DIV",{class:!0,style:!0});var o=E(t);e=C(o,"DIV",{class:!0});var _=E(e);i=C(_,"DIV",{class:!0,style:!0}),E(i).forEach(g),n=N(_),r=C(_,"DIV",{class:!0});var u=E(r);h=et(u,a),u.forEach(g),_.forEach(g),d=N(o),l=C(o,"CANVAS",{class:!0}),E(l).forEach(g),m=N(o),p&&p.l(o),o.forEach(g),this.h()},h(){S(i,"class","text-background svelte-1cip8ko"),R(i,"background","linear-gradient(180deg, "+s[0].bg+" 35%, #00000000 100%)"),S(r,"class","text-content svelte-1cip8ko"),S(e,"class","text svelte-1cip8ko"),S(l,"class","svelte-1cip8ko"),S(t,"class","panel svelte-1cip8ko"),R(t,"background-color",s[0].bg),R(t,"border-color",s[0].fg),R(t,"color",s[0].fg),It(t,"compact",s[1])},m(c,o){z(c,t,o),y(t,e),y(e,i),y(e,n),y(e,r),y(r,h),y(t,d),y(t,l),s[8](l),y(t,m),p&&p.m(t,null)},p(c,[o]){o&1&&R(i,"background","linear-gradient(180deg, "+c[0].bg+" 35%, #00000000 100%)"),o&26&&a!==(a=(c[1]?c[3]:`${c[4]}
${c[3]}`)+"")&&dt(h,a),c[6]===!0||c[5]===!0?p?p.p(c,o):(p=Gt(c),p.c(),p.m(t,null)):p&&(p.d(1),p=null),o&1&&R(t,"background-color",c[0].bg),o&1&&R(t,"border-color",c[0].fg),o&1&&R(t,"color",c[0].fg),o&2&&It(t,"compact",c[1])},i:_t,o:_t,d(c){c&&g(t),s[8](null),p&&p.d()}}}class Jt extends W{constructor(t,e,i){super();this.name=t,this.fg=e,this.bg=i,this._min=1/0,this._max=0,this.graph_x=0,this.graph_y=0,this.graph_width=100,this.graph_total_height=70,this.graph_deadzone=50,this.graph_non_deadzone=this.graph_total_height-this.graph_deadzone,this._updateText=!0,this.dynamicMax=!1,this._alreadyUpdatedDynamicMax=!1,this._currentDynamicMax=0,this._dynamicMaxTicker=new G({method:V.Manual,rate:1e4}),this._dynamicMaxStartTicker=new G({method:V.Manual,rate:1e3}),this.showExtras=!0,this._last=[],this._average=0,this._viewAverage=0,this.unit="",this.text="",this.compactText="",this._unstable=!1,this._unstableCooldown=!1,this._unstableText="",this.updateCanvas(),this._dynamicMaxTicker.on("tick",()=>this.updateDynamicTick()),this._dynamicMaxTicker.start(),this._dynamicMaxStartTicker.once("tick",()=>{this._dynamicMaxStartTicker.stop(),this.updateDynamicTick()}),this._dynamicMaxStartTicker.start()}updateSize(){this._pixelRatio=1,this._graph_x=this.graph_x*this._pixelRatio,this._graph_y=this.graph_y*this._pixelRatio,this._graph_width=this.graph_width*this._pixelRatio,this._graph_height=this.graph_deadzone*this._pixelRatio,this._graph_deadzone=this.graph_non_deadzone*this._pixelRatio,this._graph_deadzone_percent=this._graph_deadzone/(this._graph_height+this._graph_deadzone),this._canvas.width=this._graph_width,this._canvas.height=this.graph_total_height}updateCanvas(t=document.createElement("canvas")){this._canvas=t,this._context=this._canvas.getContext("2d"),this.updateSize()}rerenderAll(t=this._last,e=this._average){for(let i=0;i<t.length;i++){const n=t[i];this.render(n,e)}}render(t,e=this._average,i=this.fg,n=this.bg){if(typeof t=="number"){this._context.drawImage(this._canvas,this._graph_x+this._pixelRatio,this._graph_y,this._graph_width-this._pixelRatio,this._graph_height+this._graph_deadzone,this._graph_x,this._graph_y,this._graph_width-this._pixelRatio,this._graph_height+this._graph_deadzone),this._context.fillStyle=i;const r=Math.floor(t/e*(this._graph_height+this._graph_deadzone));this._context.fillRect(this._graph_x+this._graph_width-this._pixelRatio,this._graph_y,this._pixelRatio,this._graph_height+this._graph_deadzone);const a=r*this._graph_deadzone_percent;this._context.fillStyle=n,this._context.fillRect(this._graph_x+this._graph_width-this._pixelRatio,this._graph_y,this._pixelRatio,this._graph_height+this._graph_deadzone-a)}}updateDynamicTick(){this._currentDynamicMax=this._average,this._alreadyUpdatedDynamicMax=!0,this.dynamicMax===!0&&this.render(10,1,"#FFF")}update(t,e=this._currentDynamicMax){if(this._last.push(t),this._last.length>this._graph_width&&this._last.shift(),this._average=Math.round(At.mean(this._last)),this._viewAverage<this._average?this._viewAverage++:this._viewAverage>this._average&&this._viewAverage--,(this._alreadyUpdatedDynamicMax||!this.dynamicMax)&&this.render(t,e),typeof t=="number"&&(this._min=Math.min(this._min,t),this._max=Math.max(this._max,t)),this._dynamicMaxTicker.manualCallback(),this._dynamicMaxStartTicker.manualCallback(),this._updateText){let i=function(n){return typeof n=="number"?Math.floor(n):n};this.showExtras===!1?(this.text=`${i(t)}`,this.compactText=this.text):(this.compactText=`${i(t)} ${this.unit}`,this.text=`${i(t)} ${this.unit}
(${i(this._min)} - ${i(this._max)})`)}this.emit("update",this._min,this._max,t)}get unstable(){return this._unstable}set unstable(t){t===!1&&this._unstable===!0&&(this._unstableCooldown=!0,clearTimeout(this._unstableCooldownTimeout),this._unstableCooldownTimeout=setTimeout(()=>{this._unstableCooldown=!1},5e3)),t===!0&&(clearTimeout(this._unstableCooldownTimeout),this._unstableCooldown=!1),this._unstable=t}get unstableCooldown(){return this._unstableCooldown}set unstableText(t){this.unstable&&(this._unstableText=t)}get unstableText(){return this._unstableText}}function Ae(s,t,e){let{panel:i}=t,n,r="",a="",h;const d=ft(x=>{const J=x.debug.stats.spinner;switch(J){case U.Braille:h=["\u2807","\u280B","\u2819","\u2838","\u2834","\u2826"];break;case U.Line:h=["/","-","\\","|"];break;case U.Number:h=["0","1","2","3","4","5","6","7","8","9"];break;case U.Wiggle:h=["<","(","|",")",">",")","|","("];break;case U.Run:h=["\u2514(\u141B)\u2510","\u250C(\u141B)\u2518"];break;default:h=J;break}});let l=0;function m(x,J,k){c?e(3,r=`${h[l%h.length]} ${i.compactText}`):e(3,r=`${h[l%h.length]} ${i.text}`),l++,e(4,a=i.name),e(6,_=i.unstable),e(7,u=i.unstableText),e(5,o=i.unstableCooldown)}zt(()=>{i.updateCanvas(n),m(),i.on("update",m)});function p(){i.removeListener("update",m),d(),e(0,i=null)}jt(p);let{compact:c=!1}=t,o=!1,_=!1,u="";function w(x){H[x?"unshift":"push"](()=>{n=x,e(2,n)})}return s.$$set=x=>{"panel"in x&&e(0,i=x.panel),"compact"in x&&e(1,c=x.compact)},s.$$.update=()=>{s.$$.dirty&1&&new pe(i.bg).alpha(.5).string()},[i,c,n,r,a,o,_,u,w]}class Ie extends Z{constructor(t){super();$(this,t,Ae,Pe,Q,{panel:0,compact:1})}}var L;(function(s){s[s.None=0]="None",s[s.Error=1]="Error",s[s.Warn=2]="Warn",s[s.Info=3]="Info",s[s.Debug=4]="Debug"})(L||(L={}));var Ht;(function(s){s[s.LocalStorage=0]="LocalStorage",s[s.Server=1]="Server"})(Ht||(Ht={}));const Kt=0;async function Xt(s){switch(Kt){case 1:{const t=await fetch(`/storage/${s}`);if(t.status===404)return null;if(t.ok===!1)throw new Error(`non-ok error code: ${t.status}`);return JSON.parse(await t.text())}case 0:return JSON.parse(localStorage.getItem(s))}}async function mt(s,t){switch(Kt){case 1:{await fetch(`/storage/${s}`,{method:"POST",body:JSON.stringify(t)});return}case 0:{localStorage.setItem(s,JSON.stringify(t));return}}}var Yt;(function(s){s[s.None=0]="None",s[s.Error=1]="Error",s[s.Warn=2]="Warn",s[s.Info=3]="Info",s[s.Debug=4]="Debug"})(Yt||(Yt={}));var ot;(function(s){s[s.None=0]="None",s[s.Normal=1]="Normal",s[s.Extreme=2]="Extreme"})(ot||(ot={}));var at;(function(s){s[s.None=0]="None",s[s.NonString=1]="NonString",s[s.All=2]="All"})(at||(at={}));var X;(function(s){s[s.No=0]="No",s[s.Collapsed=1]="Collapsed",s[s.Open=2]="Open"})(X||(X={}));var U;(function(s){s[s.Line=0]="Line",s[s.Braille=1]="Braille",s[s.Number=2]="Number",s[s.Wiggle=3]="Wiggle",s[s.Run=4]="Run"})(U||(U={}));const pt=new W;function ft(s){return s(f),pt.on("update",s),()=>pt.removeListener("update",s)}const Zt={configBuild:K,timestamp:0,input:{keys:{action1:"Mouse0",action2:"Mouse2",jump:"Space",moveBackwards:"KeyS",moveForwards:"KeyW",moveLeft:"KeyA",moveRight:"KeyD",pause:"Escape",use:"KeyE",debug:"F3",fullscreen:"F11",zoom:"KeyC"},camera:{sensitivity:.001}},performance:{fixedTickerUndershoot:0,cache:1},debug:{logging:{level:1,double:0,interceptConsole:!1},stats:{show:0,spinner:1}}},ze={8:s=>(s.cache=s==null?void 0:s.advanced.cache,delete s.advanced.cache,s),9:async s=>{await mt(je,s.configBackups),delete s.configBackups}},gt="settings",je="settings-backup";let f=Zt;function Ne(){return At.defaultsDeep(f,Zt)}function xt(){f=Ne()}async function Re(){T("dbug","generating settings...");try{f=await Xt(gt),xt(),f.timestamp=Date.now();const s=f.configBuild;if(s<K){T("dbug",`settings config is behind! got ${s} while we're at ${K}.`);for(let t=s+1;t<=K;t++){const e=ze[t];typeof e=="function"&&(f=await e(f))}f.configBuild=K,T("dbug","updated settings for latest")}bt(),T("dbug","finished generating settings.")}catch(s){T("warn","error generating settings!",s),T("warn","backing up config and generating a new one..."),f===null&&xt(),await mt(`settings-backup-${Date.now()}`,await Xt(gt)),$t()}}function bt(){pt.emit("update",f)}async function $t(){T("dbug","saving settings..."),f===null&&xt(),await mt(gt,f),bt(),T("dbug","done saving settings")}const q={};for(const s in console)if(Object.prototype.hasOwnProperty.call(console,s)){const t=console[s];q[s]=t}let Qt=!1;function Be(){if(Qt===!0)return;function s(t,e){console[t]=(...i)=>T(e,...i)}s("debug","dbug"),s("log","info"),s("info","info"),s("warn","warn"),s("error","err!"),Qt=!0}ft(s=>{s.debug.logging.interceptConsole===!0&&Be()});const Fe={dbug:{stringOutput:B.gray,type:B.gray,logger:q.debug,logLevel:L.Debug},info:{logger:q.log,logLevel:L.Info},warn:{type:B.yellow.inverse,stringOutput:B.yellow,logger:q.warn,logLevel:L.Warn},"err!":{type:B.red.inverse,stringOutput:B.red,logger:q.error,logLevel:L.Error}};function T(s,...t){const e=P({time:B.gray,stack:B.gray,type:n=>n,stringOutput:n=>n,logger:q.log},Fe[s]);if(f.debug.logging.level<e.logLevel)return;t=t.map(n=>typeof n=="string"?e.stringOutput(n):n),e.logger(`[${e.time(Me())} ${e.type(s)}]`,...t);const i=f.debug.logging.double;if(i===at.All)e.logger();else if(i===at.NonString){let n=!1;for(const r of t)if(typeof r!="string"){n=!0;break}n===!0&&e.logger("")}}const Ve=globalThis;Ve.ug13Watch={};class wt{constructor(t,e=!1){this._dirty={},this._alreadyDirty=!0,this._caches=t,this._overkill=e}get dirty(){return Object.freeze(P({},this._dirty))}get caches(){return Object.freeze(P({},this._caches))}dirtyAll(){if(this._alreadyDirty===!1)for(const t in this._dirty)Object.prototype.hasOwnProperty.call(this._dirty,t)&&(this._dirty[t]=!0)}isOverkill(t){return f.performance.cache!==ot.Extreme?typeof this._overkill=="boolean"?this._overkill:this._overkill[t]===!0:!1}getDirty(t){return[!0,void 0].includes(this._dirty[t])}setDirty(t,e){return this._dirty[t]=e,e===!1&&(this._alreadyDirty=!1),e}getValue(t){return this._caches[t]}setValue(t,e){return this._caches[t]=e,e}do(t,e){return this.getDirty(t)||f.performance.cache===ot.None||this.isOverkill(t)?this.setValue(t,e()):this.getValue(t)}}function Ue(s,t,e){const i=P({undershootMultiplier:0},e);let n=performance.now(),r=0;const a=()=>{let h=!0;const d=performance.now(),l=d-n;n=d,r+=l,s>0&&r+l*i.undershootMultiplier<s&&(h=!1),t(a,h?r:null),h===!0&&(r=0)};return a}var V;(function(s){s[s.RequestAnimationFrame=0]="RequestAnimationFrame",s[s.SetInterval=1]="SetInterval",s[s.Manual=2]="Manual"})(V||(V={}));class G extends W{constructor(t){super();this._options={rate:0,method:1,maxDeltaTime:1/0,undershoot:0},this._active=!1,this._options=P(P({},this._options),t)}capDeltatime(t){return this._options.maxDeltaTime<t?this._options.maxDeltaTime:t}_emitTick(t){this.emit("tick",this.capDeltatime(t),t)}start(){if(!this.active){switch(this._active=!0,this._options.method){case 0:this._simpleTicker((t,e)=>{this._active===!0&&(requestAnimationFrame(t),e&&this._emitTick(e))})();break;case 1:{let t=performance.now();const e=setInterval(()=>{const i=performance.now(),n=i-t;t=i,this.active===!0?this._emitTick(n):clearInterval(e)},this._options.rate)}break;case 2:this.on("manualCallback",this._simpleTicker((t,e)=>{e&&this._emitTick(e)}));break}return this}}get active(){return this._active}manualCallback(){this.emit("manualCallback")}_simpleTicker(t,e){return Ue(this._options.rate,t,Pt(P({},e),{undershootMultiplier:this._options.undershoot}))}stop(){return this._active=!1,this}}class v extends W{constructor(t,e){super();this._axis=[],this._cache=new wt({readonlyAxis:null,length:null}),this._extendOptions=P({class:v,defaultDim:1,defaultStrict:!1},e),this._axis=this._extendOptions.class.arrayize(t,this._extendOptions.defaultDim),this._dimension=this._axis.length}setAxis(t,e){if(!this.inStrictDimAxisIndex(t))throw new TypeError(`out of axis range of ${this.dimension}`);return this._axis[t]=e,this._onAxisChange(t),e}_onAxisChange(t){this.emit("change",t),this._cache.dirtyAll()}inStrictDimAxisIndex(t){return!(this._extendOptions.defaultStrict&&this._extendOptions.defaultDim<t)}getAxis(t){if(!this.inStrictDimAxisIndex(t))throw new TypeError("out of index");return this._axis[t]}get axis(){return this._cache.do("readonlyAxis",()=>Object.freeze([...this._axis]))}get dimension(){return this._axis.length}set dimension(t){this._axis.length=t,this._axis=this._axis.filter(e=>e!=null?e:0)}normalize(){const t=this.length;return this.div(t),this}clone(){return new this._extendOptions.class(this._axis)}get length(){return this._cache.do("length",()=>v.distance(new this._extendOptions.class(0),this))}set length(t){this.normalize(),this.mul(t)}static add(t,e){return v.calc(t,e,(i,n)=>i+n)}static sub(t,e){return v.calc(t,e,(i,n)=>i-n)}static mul(t,e){return v.calc(t,e,(i,n)=>i*n)}static div(t,e){return v.calc(t,e,(i,n)=>i/n)}add(t){return this.set(v.add(this,t)),this}sub(t){return this.set(v.sub(this,t)),this}mul(t){return this.set(v.mul(this,t)),this}div(t){return this.set(v.div(this,t)),this}set(t){const e=new this._extendOptions.class(t);if(!this.inStrictDimAxisIndex(e.dimension))throw new TypeError(`can't set a ${this._extendOptions.class.name} to a vector with a different dimension`);this._axis=[...e.axis],this._onAxisChange(null)}static calc(t,e,i){const n=new yt(t).clone(),r=new yt(e).clone(),a=new yt;r.dimension!==n.dimension&&(r.dimension=n.dimension);for(let h=0;h<n.axis.length;h++){const d=n.axis[h],l=r.axis[h];a.setAxis(h,i(d,l))}return a}static arrayize(t,e){return typeof t=="number"?"".padEnd(e,"0").split("").map(i=>parseFloat(i)):Array.isArray(t)?t:t?[...t.axis]:this.arrayize(0,e)}static distance(t,e){let i=0;const n=t.clone(),r=e.clone();n.dimension!==r.dimension&&(r.dimension=n.dimension);for(let a=0;a<n.axis.length;a++){const h=n.axis[a],d=r.axis[a];i+=(h-d)**2}return Math.sqrt(i)}static axisNumberToString(t){switch(t){case 0:return"x";case 1:return"y";case 2:return"z";case 3:return"w"}}}class yt extends v{}const vt=class extends v{constructor(s){super(s,{class:vt,defaultDim:1,defaultStrict:!0})}get x(){return this.getAxis(0)}set x(s){this.setAxis(0,s)}};let We=vt;We.class=vt;const kt=class extends v{constructor(s){super(s,{class:kt,defaultDim:2,defaultStrict:!0})}get x(){return this.getAxis(0)}set x(s){this.setAxis(0,s)}get y(){return this.getAxis(1)}set y(s){this.setAxis(1,s)}};let A=kt;A.class=kt;const Tt=class extends v{constructor(s){super(s,{class:Tt,defaultDim:3,defaultStrict:!0})}get x(){return this.getAxis(0)}set x(s){this.setAxis(0,s)}get y(){return this.getAxis(1)}set y(s){this.setAxis(1,s)}get z(){return this.getAxis(2)}set z(s){this.setAxis(2,s)}};let ht=Tt;ht.class=Tt;const St=class extends v{constructor(s){super(s,{class:St,defaultDim:4,defaultStrict:!0})}get x(){return this.getAxis(0)}set x(s){this.setAxis(0,s)}get y(){return this.getAxis(1)}set y(s){this.setAxis(1,s)}get z(){return this.getAxis(2)}set z(s){this.setAxis(2,s)}get w(){return this.getAxis(3)}set w(s){this.setAxis(3,s)}};let Le=St;Le.class=St;function te(s,t,e=0){const i=Math.abs(s),n=i.toFixed();`${i}`.length-n.length;let r=n.length+e;const a=t;let h=!1;for(;;){const l=i.toPrecision(r);if(l.length>=a){e===0&&l.indexOf(".")&&l.length>a&&(h=!0);break}r++}const d=s.toPrecision(r);return h?Oe(d,"0",t):d}class qe extends W{constructor(t){super();this._canvas=t,this.fixedTickerRate=1e3/20,this.maxDeltatime=1e3/19,this.inputController=new Xe(this._canvas),this._debugText=["..."],this._debugTextShort=["..."],this._lastButtonPressed=null,this._assets=new Ze({models:{player:"/assets/models/player.gltf"}}),this._room=new $e,this._thing=new lt}get debugText(){return this._debugText}get debugTextShort(){return this._debugTextShort}_getDebugPosition(t,e=10){return t.map(i=>te(i,e,3)).join(", ")}_getDebugRotation(t){return t.map(e=>te(e*(180/Math.PI),10,3)).join(", ")}_updateDebugText(){const t=this._rendering.camera,e=this._player;this._debugTextShort=[`${e.position.axis.map(i=>Math.floor(i)).join(", ")}`],this._debugText=[`player pos: ${this._getDebugPosition(e.position.axis)}`,`(${this._getDebugRotation(e.rotation.axis)})`,`cam pos: ${this._getDebugPosition(t.position.axis)}`,` (${this._getDebugRotation(t.rotation.axis)})`,`${(()=>{let i="";for(const n of ee)i+=this.inputController.getInput(n)?Ke[n]:"_";return i})()} ${this._lastButtonPressed}`,`${this.inputController.mouseLocked?"cam":"mus"} ${(()=>{const i=this.inputController.mouseLocked;let n="";return i?n+=this._getDebugPosition(this.inputController.getInput("camera").position.axis,7):n+=this._getDebugPosition(this.inputController.getInput("mouse").position.axis,7),n})()}`,...(()=>{const i=globalThis.ug13Watch,n=[];for(const r in i)if(Object.prototype.hasOwnProperty.call(i,r)){const a=i[r];n.push(`
    ${r}: ${a}`)}return n.unshift(`ug13Watch (${n.length}) = {`),n.push("}"),n})()]}get player(){return this._player}async start(t){await Re(),await $t(),this.frameTicker=new G({maxDeltaTime:this.maxDeltatime,method:V.RequestAnimationFrame});const e=f.performance.fixedTickerUndershoot;e!==0?(this.fixedTicker=new G({method:V.Manual,rate:this.fixedTickerRate,undershoot:e,maxDeltaTime:this.maxDeltatime}),this.frameTicker.on("tick",()=>this.fixedTicker.manualCallback())):this.fixedTicker=new G({method:V.SetInterval,rate:this.fixedTickerRate,undershoot:e,maxDeltaTime:this.maxDeltatime}),this._rendering=new Ye(this._canvas,this.frameTicker,this._assets,this._room),this._player=new Ge(this._assets,this._room.world,this.inputController,this._rendering.camera,this),await this._assets.loadAssets(t),await this._rendering.start(),this.inputController.on("action1",r=>{r===!0&&this.inputController.lockPointer()}),this.inputController.on("pause",r=>{r===!0&&this.inputController.unlockPointer()}),this.inputController.listen(),this.inputController.on("buttonDown",r=>{this._lastButtonPressed=r.button}),this.frameTicker.start().on("tick",this._frameTick.bind(this)),this.fixedTicker.start().on("tick",this._fixedTick.bind(this)),this._updateSize(),window.addEventListener("resize",this._updateSize.bind(this)),this.emit("loaded");const n=this._thing;return this._room.world.add(n),this._thing.position.y=-1,this.inputController.on("debug",r=>{r===!0&&(f.debug.stats.show++,f.debug.stats.show>2&&(f.debug.stats.show=0)),bt()}),this}async stop(){throw new Error("not implemented")}_updateSize(){this._rendering.updateSize()}_frameTick(t){this._updateDebugText(),this.emit("frameTick",t)}_fixedTick(t){this.emit("fixedTick",t)}_setup(){throw new Error("not implemented")}_loadAssets(){throw new Error("not implemented")}}class lt{constructor(){this._rendererObject=new fe(new ge(1,1,1),new xe({color:16711680})),this._parent=null,this.position=new ht,this.rotation=new ht,this.velocity=new ht,this._name="",this._rotationOrder="XYZ",this._cache=new wt({children:null}),this._children=[],this.position.on("change",t=>{this._processVectorChange("position",t)}),this.rotation.on("change",t=>{this._processVectorChange("rotation",t)})}get rotationOrder(){return this._rotationOrder}set rotationOrder(t){this._rotationOrder=t,this._rendererObject.rotation.order=t}toString(){return`[Thing ${this.name}]`}get parent(){return this._parent}set parent(t){this.changeParent(t)}get name(){return this._name}set name(t){this._name=t,this._rendererObject.name=t}_processVectorChange(t,e){if(e===null){const n=this[t].axis;for(let r=0;r<n.length;r++){const a=v.axisNumberToString(r);this._rendererObject[t][a]=n[r]}}const i=v.axisNumberToString(e);this._rendererObject[t][i]=this[t][i]}get children(){return this._cache.do("children",()=>Object.freeze([...this._children]))}get rendererObject(){return this._rendererObject}add(t){return t._children.push(t),this._rendererObject.add(t._rendererObject),this._cache.setDirty("children",!0),t.changeParent(this,!1),t}changeParent(t,e=!0){var i;e===!0&&((i=this.parent)==null||i.remove(this),t==null||t.add(this)),this._parent=t}remove(t){for(let e=0;e<this._children.length;e++)if(this._children[e]===t){this._children.splice(e,1);break}return t.changeParent(null,!1),this}getChildFromName(t){for(const e of this._children)if(e.name===t)return e;return null}}class Ge extends lt{constructor(t,e,i,n,r){super();this.model=t,this.world=e,this.input=i,this.camera=n,this.game=r,this.world.add(this),T("info",this),this._setupPlayerCamera(),this._subscribeToControls()}_setupPlayerCamera(){this.camera.parent=this,this.rotationOrder="YXZ"}_subscribeToControls(){this.input.on("camera",t=>{const e=f.input.camera.sensitivity;this.rotation.x-=t.movement.y*e,this.rotation.y-=t.movement.x*e}),this.game.on("frameTick",t=>{const e=.01,i=Math.sin(this.rotation.y%(Math.PI*2)),n=Math.cos(this.rotation.y%(Math.PI*2)),r=Math.sin((this.rotation.y+Math.PI*.5)%(Math.PI*2)),a=Math.cos((this.rotation.y+Math.PI*.5)%(Math.PI*2));this.input.getInput("moveForwards")&&(this.position.x-=i*e*t,this.position.z-=n*e*t),this.input.getInput("moveBackwards")&&(this.position.x+=i*e*t,this.position.z+=n*e*t),this.input.getInput("moveLeft")&&(this.position.x-=r*e*t,this.position.z-=a*e*t),this.input.getInput("moveRight")&&(this.position.x+=r*e*t,this.position.z+=a*e*t)})}}class Je extends lt{constructor(){super(...arguments);this._rendererObject=new be,this._aspect=1}get rendererObject(){return this._rendererObject}get aspect(){return this._aspect}set aspect(t){this._aspect=t,this._rendererObject.aspect=this.aspect}updateProjectionMatrix(){this._rendererObject.updateProjectionMatrix()}}class He extends lt{constructor(){super(...arguments);this._rendererObject=new we}get rendererObject(){return this._rendererObject}}const ee=["jump","use","action1","action2","moveForwards","moveBackwards","moveLeft","moveRight","pause","debug","fullscreen","zoom"],Ke={action1:"1",action2:"2",camera:"C",debug:"D",jump:"J",mouse:"M",moveBackwards:"v",moveForwards:"^",moveLeft:"<",moveRight:">",pause:"P",use:"E",fullscreen:"F",zoom:"Z"};class Xe extends W{constructor(t,e=window,i=document){super();this._element=t,this._window=e,this._document=i,this._mouseLocked=!1,this._inputs={mouse:{movement:new A,position:new A},camera:{movement:new A,position:new A}},this._assignmentToButtonCache=new wt({},!1),this._buttons={}}get element(){return this._element}get window(){return this._window}get document(){return this._document}listen(){this._setupEvents()}_setupEvents(){this._element.addEventListener("mousedown",this._mouseDown.bind(this)),this._element.addEventListener("mouseup",this._mouseUp.bind(this)),this._window.addEventListener("keydown",this._keyDown.bind(this)),this._window.addEventListener("keyup",this._keyUp.bind(this)),this._element.addEventListener("contextmenu",this._contextMenu.bind(this)),this._window.addEventListener("blur",this._unfocus.bind(this)),this._window.addEventListener("mousemove",this._mouseMove.bind(this)),this._document.addEventListener("pointerlockchange",this._pointerLockChange.bind(this))}get mouseLocked(){return this._mouseLocked}_pointerLockChange(){this._mouseLocked=this.document.pointerLockElement===this._element}get inputs(){return this._inputs}_mouseNumberToString(t){return`Mouse${t}`}_mouseDown(t){t.preventDefault(),this._buttonDown(this._mouseNumberToString(t.button))}_contextMenu(t){return t.preventDefault(),!1}_unfocus(){for(const t in this._inputs)Object.prototype.hasOwnProperty.call(this._inputs,t)&&ee.includes(t)&&this._processButtonInputEvent(t,!1)}_mouseUp(t){t.preventDefault(),this._buttonUp(this._mouseNumberToString(t.button))}_keyDown(t){t.preventDefault(),this._buttonDown(t.code)}_keyUp(t){t.preventDefault(),this._buttonUp(t.code)}_buttonDown(t){this._processButtonEvent(t,!0)}_buttonUp(t){this._processButtonEvent(t,!1)}_processButtonInputEvent(t,e,i=f.input[t]){const n={button:i,mapped:t};e===!0?this.emit("buttonDown",n):this.emit("buttonUp",n),t!=="none"&&(this._inputs[t]=e,this.emit(t,e))}_getButtonInputFromButton(t){return this._assignmentToButtonCache.do(t,()=>{const e=f.input.keys;for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)&&e[i]===t)return i;return"none"})}_processButtonEvent(t,e){if(this._buttons[t]===e)return;this._buttons[t]=e;const i=this._getButtonInputFromButton(t);this._processButtonInputEvent(i,e,t)}_mouseMove(t){this._inputs.mouse={movement:new A([t.movementX,t.movementY]),position:new A([t.clientX,t.clientY])},this._mouseLocked===!0&&(this._inputs.camera={movement:new A(this._inputs.mouse.movement),position:new A(this._inputs.camera.position).add(this._inputs.mouse.movement)},this.emit("camera",this._inputs.mouse)),this.emit("mouse",this._inputs.mouse)}lockPointer(){this._element.requestPointerLock()}unlockPointer(){this._document.exitPointerLock()}getButtonDown(t){return this._buttons[t]===!0}getInput(t){const e=this._inputs[t];return e===void 0?!1:e}_removeEvents(){}}class Ye{constructor(t,e,i,n){this._canvas=t,this._ticker=e,this._assets=i,this._room=n,this._canvasContext=this._canvas.getContext("webgl"),this.camera=new Je,this._resolution=1,this._room.world.add(this.camera)}set resolution(t){this._resolution=t,this.updateSize()}get resolution(){return this._resolution}setupRenderer(){T("dbug","setting up renderer..."),this._renderer=new ye({context:this._canvasContext,antialias:!1}),T("dbug","done setting up renderer.")}async start(){return this.setupRenderer(),this.updateSize(),this._room.world.rendererObject.background=new ve(2236962),this._ticker.on("tick",this._frameTick.bind(this)),this}_frameTick(t){this._renderer.render(this._room.world.rendererObject,this.camera.rendererObject)}updateSize(){const t=innerWidth*this._resolution,e=innerHeight*this._resolution;return this._canvas.width=t,this._canvas.height=e,this._renderer.setSize(t,e),this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this}}class Ze{constructor(t){this._assets=t,this.assets={models:{},images:{}}}async loadAssets(t){await this._loadAssets(t)}async _loadAssets(t){T("dbug","loading assets...");function e(a,h){let d=0,l=0;for(const m of i)d+=m.loaded,l+=m.total;t==null||t(d,l,"Downloading assets",`${h} ${a}`)}const i=[],n=this._assets.models;for(const a in n)if(Object.prototype.hasOwnProperty.call(n,a)){const h=n[a],d=ke.extname(h);let l;switch(d){case".gltf":l=Te}if(l!==void 0){const m=new l,p={promise:Promise.resolve(),loaded:0,total:0};p.promise=m.loadAsync(h,c=>{p.loaded=c.loaded,p.total=c.total,e("model",d)}),p.promise.then(c=>{this.assets.models[a]=c}),i.push(p)}else{const m=new Error(`Unknown file type ${d} (${a})`);throw T("err!",m.message),m}}const r=i.map(a=>a.promise);await Promise.all(r),T("dbug","done loading assets",this.assets)}}class $e{constructor(){this.world=new He}}function se(s,t,e){const i=s.slice();return i[7]=t[e],i}function ie(s,t,e){const i=s.slice();return i[10]=t[e],i[12]=e,i}function ne(s){let t,e,i,n,r,a,h,d=s[1],l=[];for(let o=0;o<d.length;o+=1)l[o]=re(ie(s,d,o));const m=o=>F(l[o],1,1,()=>{l[o]=null});let p=s[0]?s[3]:s[4],c=[];for(let o=0;o<p.length;o+=1)c[o]=oe(se(s,p,o));return{c(){t=D("div"),e=D("div");for(let o=0;o<l.length;o+=1)l[o].c();i=j(),n=D("div");for(let o=0;o<c.length;o+=1)c[o].c();this.h()},l(o){t=C(o,"DIV",{class:!0});var _=E(t);e=C(_,"DIV",{class:!0});var u=E(e);for(let x=0;x<l.length;x+=1)l[x].l(u);u.forEach(g),i=N(_),n=C(_,"DIV",{class:!0});var w=E(n);for(let x=0;x<c.length;x+=1)c[x].l(w);w.forEach(g),_.forEach(g),this.h()},h(){S(e,"class","panels svelte-1xg1opo"),S(n,"class","text svelte-1xg1opo"),S(t,"class",r="container "+(s[0]?"":"hidden")+" svelte-1xg1opo")},m(o,_){z(o,t,_),y(t,e);for(let u=0;u<l.length;u+=1)l[u].m(e,null);y(t,i),y(t,n);for(let u=0;u<c.length;u+=1)c[u].m(n,null);h=!0},p(o,_){if(s=o,_&3){d=s[1];let u;for(u=0;u<d.length;u+=1){const w=ie(s,d,u);l[u]?(l[u].p(w,_),O(l[u],1)):(l[u]=re(w),l[u].c(),O(l[u],1),l[u].m(e,null))}for(Nt(),u=d.length;u<l.length;u+=1)m(u);Rt()}if(_&25){p=s[0]?s[3]:s[4];let u;for(u=0;u<p.length;u+=1){const w=se(s,p,u);c[u]?c[u].p(w,_):(c[u]=oe(w),c[u].c(),c[u].m(n,null))}for(;u<c.length;u+=1)c[u].d(1);c.length=p.length}(!h||_&1&&r!==(r="container "+(s[0]?"":"hidden")+" svelte-1xg1opo"))&&S(t,"class",r)},i(o){if(!h){for(let _=0;_<d.length;_+=1)O(l[_]);De(()=>{a||(a=Bt(t,Vt,{duration:200,easing:Ft},!0)),a.run(1)}),h=!0}},o(o){l=l.filter(Boolean);for(let _=0;_<l.length;_+=1)F(l[_]);a||(a=Bt(t,Vt,{duration:200,easing:Ft},!1)),a.run(0),h=!1},d(o){o&&g(t),Ut(l,o),Ut(c,o),o&&a&&a.end()}}}function re(s){let t,e,i,n,r,a;return e=new Ie({props:{panel:s[10],compact:!s[0]}}),{c(){t=D("div"),st(e.$$.fragment),i=j(),this.h()},l(h){t=C(h,"DIV",{class:!0});var d=E(t);it(e.$$.fragment,d),i=N(d),d.forEach(g),this.h()},h(){S(t,"class","panel "+(s[12]===0?"top":"")+" svelte-1xg1opo")},m(h,d){z(h,t,d),nt(e,t,null),y(t,i),n=!0,r||(a=Se(t,"click",s[6]),r=!0)},p(h,d){const l={};d&2&&(l.panel=h[10]),d&1&&(l.compact=!h[0]),e.$set(l)},i(h){n||(O(e.$$.fragment,h),n=!0)},o(h){F(e.$$.fragment,h),n=!1},d(h){h&&g(t),rt(e),r=!1,a()}}}function oe(s){let t,e=s[7]+"",i;return{c(){t=D("span"),i=tt(e),this.h()},l(n){t=C(n,"SPAN",{class:!0});var r=E(t);i=et(r,e),r.forEach(g),this.h()},h(){S(t,"class","line svelte-1xg1opo")},m(n,r){z(n,t,r),y(t,i)},p(n,r){r&25&&e!==(e=n[7]+"")&&dt(i,e)},d(n){n&&g(t)}}}function Qe(s){let t,e,i=s[2]&&ne(s);return{c(){i&&i.c(),t=Wt()},l(n){i&&i.l(n),t=Wt()},m(n,r){i&&i.m(n,r),z(n,t,r),e=!0},p(n,[r]){n[2]?i?(i.p(n,r),r&4&&O(i,1)):(i=ne(n),i.c(),O(i,1),i.m(t.parentNode,t)):i&&(Nt(),F(i,1,1,()=>{i=null}),Rt())},i(n){e||(O(i),e=!0)},o(n){F(i),e=!1},d(n){i&&i.d(n),n&&g(t)}}}function ts(s,t,e){let{open:i=!1}=t,{active:n=!1}=t,{panels:r=[]}=t,{text:a=[]}=t,{textClosed:h=[]}=t;function d(m){e(1,r=[...r,m])}const l=m=>{m.preventDefault(),e(0,i=!i)};return s.$$set=m=>{"open"in m&&e(0,i=m.open),"active"in m&&e(2,n=m.active),"panels"in m&&e(1,r=m.panels),"text"in m&&e(3,a=m.text),"textClosed"in m&&e(4,h=m.textClosed)},[i,r,n,a,h,d,l]}class es extends Z{constructor(t){super();$(this,t,ts,Qe,Q,{open:0,active:2,panels:1,text:3,textClosed:4,addPanel:5})}get addPanel(){return this.$$.ctx[5]}}class ae extends Jt{constructor(...t){super(...t);this._lowestThisSection=1/0,this._highestThisSection=0,this._TPSTicker=new G({method:V.Manual,rate:1e3}),this.showExtras=!0,this._updateText=!1,this._TPSTicker.start(),this.on("update",(e,i,n)=>{this._lowestThisSection>n?this._lowestThisSection=n:this._highestThisSection<n&&(this._highestThisSection=n),this._TPSTicker.manualCallback()}),this._TPSTicker.on("tick",()=>this.updateText())}updateText(){this.text="";function t(i){return typeof i=="number"?Math.floor(i):i}const e=`${t(this._lowestThisSection)}/${t(this._highestThisSection)}`;this.compactText=`${e} ${this.unit}`,this.text=`${e} ${this.unit}
(${t(this._min)} - ${t(this._max)})`,this._lowestThisSection=1/0,this._highestThisSection=0}}function ss(s){let t,e,i,n,r,a,h,d,l;n=new Ee({props:{show:s[4],info:s[2],percent:s[3],title:s[1],error:s[5]}});function m(o){s[13](o)}function p(o){s[14](o)}let c={text:s[9],textClosed:s[10]};return s[8]!==void 0&&(c.open=s[8]),s[7]!==void 0&&(c.active=s[7]),a=new es({props:c}),s[12](a),H.push(()=>Lt(a,"open",m)),H.push(()=>Lt(a,"active",p)),{c(){t=D("main"),e=D("canvas"),i=j(),st(n.$$.fragment),r=j(),st(a.$$.fragment),this.h()},l(o){t=C(o,"MAIN",{});var _=E(t);e=C(_,"CANVAS",{id:!0,class:!0}),E(e).forEach(g),i=N(_),it(n.$$.fragment,_),r=N(_),it(a.$$.fragment,_),_.forEach(g),this.h()},h(){S(e,"id","canvas"),S(e,"class","svelte-zbttt9")},m(o,_){z(o,t,_),y(t,e),s[11](e),y(t,i),nt(n,t,null),y(t,r),nt(a,t,null),l=!0},p(o,[_]){const u={};_&16&&(u.show=o[4]),_&4&&(u.info=o[2]),_&8&&(u.percent=o[3]),_&2&&(u.title=o[1]),_&32&&(u.error=o[5]),n.$set(u);const w={};_&512&&(w.text=o[9]),_&1024&&(w.textClosed=o[10]),!h&&_&256&&(h=!0,w.open=o[8],qt(()=>h=!1)),!d&&_&128&&(d=!0,w.active=o[7],qt(()=>d=!1)),a.$set(w)},i(o){l||(O(n.$$.fragment,o),O(a.$$.fragment,o),l=!0)},o(o){F(n.$$.fragment,o),F(a.$$.fragment,o),l=!1},d(o){o&&g(t),s[11](null),rt(n),s[12](null),rt(a)}}}function is(s,t,e){jt(()=>{});let i,n="Downloading webpage",r="",a=0,h=!0,d=!0,l=!1,m,p=!1,c=!1,o=["xyz: 0, 0, 0"],_=["0, 0, 0"];zt(()=>{(async()=>{const k=new qe(i);k.on("loaded",()=>{d!==!1&&(e(4,h=!1),e(1,n="Done"),e(2,r=""),d=!1)});try{await k.start((b,I,Y,ut)=>{d!==!1&&(e(3,a=b/I),e(1,n=Y),e(2,r=ut))})}catch(b){e(1,n="Failed to load"),e(2,r=`${b}`),d=!1,e(5,l=!0),T("err!","error loading game:",b)}ft(b=>{switch(b.debug.stats.show){case X.No:e(7,p=!1),e(8,c=!1);break;case X.Collapsed:e(7,p=!0),e(8,c=!1);break;case X.Open:e(7,p=!0),e(8,c=!0);break}});const ct=new ae("Frame TPS","#0FF","#022"),Dt=new ae("Fixed TPS","#FF0","#220"),M=new Jt("Memory","#F0F","#202");m.addPanel(ct),m.addPanel(Dt),m.addPanel(M),M.unit="MB";function Ct(b){return Math.floor(1e3/b)}function he(){if(performance.memory){M.update(performance.memory.usedJSHeapSize*1e-6),M.showExtras=!0;const b=performance.memory.usedJSHeapSize/performance.memory.jsHeapSizeLimit;M.dynamicMax=!0,M.unstable=b>.5,M.unstableText=`${Math.floor(b*100)}% usage`}else M.update(`???
No memory
support`),M.dynamicMax=!1,M.showExtras=!1}ct.dynamicMax=!0;function Et(b,I,Y,ut){b.update(Ct(Y),ut),b.unstable=I!==Y,b.unstableText=`faking ${Ct(I)}TPS`}k.frameTicker.on("tick",(b,I)=>{Et(ct,b,I),e(9,o=k.debugText),e(10,_=k.debugTextShort)}),k.fixedTicker.on("tick",(b,I)=>{Et(Dt,b,I,20),he()})})()});function u(k){H[k?"unshift":"push"](()=>{i=k,e(0,i)})}function w(k){H[k?"unshift":"push"](()=>{m=k,e(6,m)})}function x(k){c=k,e(8,c)}function J(k){p=k,e(7,p)}return[i,n,r,a,h,l,m,p,c,o,_,u,w,x,J]}class ns extends Z{constructor(t){super();$(this,t,is,ss,Q,{})}}function rs(s){let t,e,i;return e=new ns({}),{c(){t=j(),st(e.$$.fragment),this.h()},l(n){Ce('[data-svelte="svelte-4vcxiu"]',document.head).forEach(g),t=N(n),it(e.$$.fragment,n),this.h()},h(){document.title="..."},m(n,r){z(n,t,r),nt(e,n,r),i=!0},p:_t,i(n){i||(O(e.$$.fragment,n),i=!0)},o(n){F(e.$$.fragment,n),i=!1},d(n){n&&g(t),rt(e,n)}}}class ls extends Z{constructor(t){super();$(this,t,null,rs,Q,{})}}export{ls as default};
