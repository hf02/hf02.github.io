import{J as Ut,S as X,i as H,s as W,e as x,t as J,c as S,a as y,g as q,d as f,b as v,f as P,M as T,h as it,j as I,l as A,R,L as Z,W as nt,u as _t,X as mt,Y as Ft,Z as N,_ as gt,$ as Nt,a0 as Vt,a1 as Yt,a2 as Gt,a3 as Xt,a4 as Ht,a5 as Wt,a6 as Jt,a7 as qt,a8 as Zt,a9 as Qt,p as L,v as Q,w as K,x as $,aa as Kt,n as j,A as tt,m as pt,o as ft,N as $t,P as wt,Q as bt,k as Tt,T as vt,U as kt,ab as xt,ac as St,E as te}from"../chunks/vendor-23a4166d.js";import{T as et,a as B,b as U,d as ot,S as V,V as ee,l as M,g as se,s as ie,c as E,P as ne,e as Y,u as oe,f as ae,C as re,L as he,h as at,i as yt}from"../chunks/Player-dac62f5e.js";function le(n,t,e){return n.padEnd(e,t).slice(0,e)}function Mt(n){let t,e,s,i;return{c(){t=x("div"),e=J("! "),s=J(n[7]),this.h()},l(a){t=S(a,"DIV",{class:!0});var r=y(t);e=q(r,"! "),s=q(r,n[7]),r.forEach(f),this.h()},h(){v(t,"class",i="unstable "+(n[5]?"cooldown":"")+" svelte-1cip8ko")},m(a,r){P(a,t,r),T(t,e),T(t,s)},p(a,r){r&128&&it(s,a[7]),r&32&&i!==(i="unstable "+(a[5]?"cooldown":"")+" svelte-1cip8ko")&&v(t,"class",i)},d(a){a&&f(t)}}}function ce(n){let t,e,s,i,a,r=(n[1]?n[3]:`${n[4]}
${n[3]}`)+"",h,_,l,m,g=(n[6]===!0||n[5]===!0)&&Mt(n);return{c(){t=x("div"),e=x("div"),s=x("div"),i=I(),a=x("div"),h=J(r),_=I(),l=x("canvas"),m=I(),g&&g.c(),this.h()},l(d){t=S(d,"DIV",{class:!0,style:!0});var o=y(t);e=S(o,"DIV",{class:!0});var c=y(e);s=S(c,"DIV",{class:!0,style:!0}),y(s).forEach(f),i=A(c),a=S(c,"DIV",{class:!0});var u=y(a);h=q(u,r),u.forEach(f),c.forEach(f),_=A(o),l=S(o,"CANVAS",{class:!0}),y(l).forEach(f),m=A(o),g&&g.l(o),o.forEach(f),this.h()},h(){v(s,"class","text-background svelte-1cip8ko"),R(s,"background","linear-gradient(180deg, "+n[0].bg+" 35%, #00000000 100%)"),v(a,"class","text-content svelte-1cip8ko"),v(e,"class","text svelte-1cip8ko"),v(l,"class","svelte-1cip8ko"),v(t,"class","panel svelte-1cip8ko"),R(t,"background-color",n[0].bg),R(t,"border-color",n[0].fg),R(t,"color",n[0].fg),Z(t,"compact",n[1])},m(d,o){P(d,t,o),T(t,e),T(e,s),T(e,i),T(e,a),T(a,h),T(t,_),T(t,l),n[8](l),T(t,m),g&&g.m(t,null)},p(d,[o]){o&1&&R(s,"background","linear-gradient(180deg, "+d[0].bg+" 35%, #00000000 100%)"),o&26&&r!==(r=(d[1]?d[3]:`${d[4]}
${d[3]}`)+"")&&it(h,r),d[6]===!0||d[5]===!0?g?g.p(d,o):(g=Mt(d),g.c(),g.m(t,null)):g&&(g.d(1),g=null),o&1&&R(t,"background-color",d[0].bg),o&1&&R(t,"border-color",d[0].fg),o&1&&R(t,"color",d[0].fg),o&2&&Z(t,"compact",d[1])},i:nt,o:nt,d(d){d&&f(t),n[8](null),g&&g.d()}}}class Et extends et{constructor(t,e,s){super();this.name=t,this.fg=e,this.bg=s,this._min=1/0,this._max=0,this.graph_x=0,this.graph_y=0,this.graph_width=100,this.graph_total_height=70,this.graph_deadzone=50,this.graph_non_deadzone=this.graph_total_height-this.graph_deadzone,this._updateText=!0,this.dynamicMax=!1,this._alreadyUpdatedDynamicMax=!1,this._currentDynamicMax=0,this._dynamicMaxTicker=new B({method:U.Manual,rate:1e4}),this._dynamicMaxStartTicker=new B({method:U.Manual,rate:1e3}),this.showExtras=!0,this._last=[],this._average=0,this._viewAverage=0,this.unit="",this.text="",this.compactText="",this._unstable=!1,this._unstableCooldown=!1,this._unstableText="",this.updateCanvas(),this._dynamicMaxTicker.on("tick",()=>this.updateDynamicTick()),this._dynamicMaxTicker.start(),this._dynamicMaxStartTicker.once("tick",()=>{this._dynamicMaxStartTicker.stop(),this.updateDynamicTick()}),this._dynamicMaxStartTicker.start()}updateSize(){this._pixelRatio=1,this._graph_x=this.graph_x*this._pixelRatio,this._graph_y=this.graph_y*this._pixelRatio,this._graph_width=this.graph_width*this._pixelRatio,this._graph_height=this.graph_deadzone*this._pixelRatio,this._graph_deadzone=this.graph_non_deadzone*this._pixelRatio,this._graph_deadzone_percent=this._graph_deadzone/(this._graph_height+this._graph_deadzone),this._canvas.width=this._graph_width,this._canvas.height=this.graph_total_height}updateCanvas(t=document.createElement("canvas")){this._canvas=t,this._context=this._canvas.getContext("2d"),this.updateSize()}rerenderAll(t=this._last,e=this._average){for(let s=0;s<t.length;s++){const i=t[s];this.render(i,e)}}render(t,e=this._average,s=this.fg,i=this.bg){if(typeof t=="number"){this._context.drawImage(this._canvas,this._graph_x+this._pixelRatio,this._graph_y,this._graph_width-this._pixelRatio,this._graph_height+this._graph_deadzone,this._graph_x,this._graph_y,this._graph_width-this._pixelRatio,this._graph_height+this._graph_deadzone),this._context.fillStyle=s;const a=Math.floor(t/e*(this._graph_height+this._graph_deadzone));this._context.fillRect(this._graph_x+this._graph_width-this._pixelRatio,this._graph_y,this._pixelRatio,this._graph_height+this._graph_deadzone);const r=a*this._graph_deadzone_percent;this._context.fillStyle=i,this._context.fillRect(this._graph_x+this._graph_width-this._pixelRatio,this._graph_y,this._pixelRatio,this._graph_height+this._graph_deadzone-r)}}updateDynamicTick(){this._currentDynamicMax=this._average,this._alreadyUpdatedDynamicMax=!0,this.dynamicMax===!0&&this.render(10,1,"#FFF")}update(t,e=this._currentDynamicMax){if(this._last.push(t),this._last.length>this._graph_width&&this._last.shift(),this._average=Math.round(Ut.mean(this._last)),this._viewAverage<this._average?this._viewAverage++:this._viewAverage>this._average&&this._viewAverage--,(this._alreadyUpdatedDynamicMax||!this.dynamicMax)&&this.render(t,e),typeof t=="number"&&(this._min=Math.min(this._min,t),this._max=Math.max(this._max,t)),this._dynamicMaxTicker.manualCallback(),this._dynamicMaxStartTicker.manualCallback(),this._updateText){let s=function(i){return typeof i=="number"?Math.floor(i):i};this.showExtras===!1?(this.text=`${s(t)}`,this.compactText=this.text):(this.compactText=`${s(t)} ${this.unit}`,this.text=`${s(t)} ${this.unit}
(${s(this._min)} - ${s(this._max)})`)}this.emit("update",this._min,this._max,t)}get unstable(){return this._unstable}set unstable(t){t===!1&&this._unstable===!0&&(this._unstableCooldown=!0,clearTimeout(this._unstableCooldownTimeout),this._unstableCooldownTimeout=setTimeout(()=>{this._unstableCooldown=!1},5e3)),t===!0&&(clearTimeout(this._unstableCooldownTimeout),this._unstableCooldown=!1),this._unstable=t}get unstableCooldown(){return this._unstableCooldown}set unstableText(t){this.unstable&&(this._unstableText=t)}get unstableText(){return this._unstableText}}function ue(n,t,e){let{panel:s}=t,i,a="",r="",h;const _=ot(w=>{const F=w.debug.stats.spinner;switch(F){case V.Braille:h=["\u2807","\u280B","\u2819","\u2838","\u2834","\u2826"];break;case V.Line:h=["/","-","\\","|"];break;case V.Number:h=["0","1","2","3","4","5","6","7","8","9"];break;case V.Wiggle:h=["<","(","|",")",">",")","|","("];break;case V.Run:h=["\u2514(\u141B)\u2510","\u250C(\u141B)\u2518"];break;default:h=F;break}});let l=0;function m(w,F,rt){d?e(3,a=`${h[l%h.length]} ${s.compactText}`):e(3,a=`${h[l%h.length]} ${s.text}`),l++,e(4,r=s.name),e(6,c=s.unstable),e(7,u=s.unstableText),e(5,o=s.unstableCooldown)}_t(()=>{s.updateCanvas(i),m(),s.on("update",m)});function g(){s.removeListener("update",m),_(),e(0,s=null)}mt(g);let{compact:d=!1}=t,o=!1,c=!1,u="";function b(w){N[w?"unshift":"push"](()=>{i=w,e(2,i)})}return n.$$set=w=>{"panel"in w&&e(0,s=w.panel),"compact"in w&&e(1,d=w.compact)},n.$$.update=()=>{n.$$.dirty&1&&new Ft(s.bg).alpha(.5).string()},[s,d,i,a,r,o,c,u,b]}class de extends X{constructor(t){super();H(this,t,ue,ce,W,{panel:0,compact:1})}}function Dt(n,t,e=0){const s=Math.abs(n),i=s.toFixed();`${s}`.length-i.length;let a=i.length+e;const r=t;let h=!1;for(;a<r;){const l=s.toPrecision(a);if(l.length>=r){e===0&&l.indexOf(".")&&l.length>r&&(h=!0);break}a++}const _=n.toPrecision(a);return h?le(_,"0",t):_}function _e(n){let t=0,e,s;if(n.length===0)return t;for(e=0;e<n.length;e++)s=n.charCodeAt(e),t=(t<<5)-t+s,t|=0;return t}function me(n,t,e){return e===void 0?Math.floor(new gt().rndHiRes()*(t+1-n))+n:(typeof e=="string"&&(e=_e(e)),Math.floor(new gt(e).rndHiRes()*(t+1-n))+n)}function ge(n){return n[me(0,n.length-1)]}class z extends ee{constructor(t){super(t,2)}get x(){return this.getAxis(0)}set x(t){this.setAxis(0,t)}get y(){return this.getAxis(1)}set y(t){this.setAxis(1,t)}}class pe extends et{constructor(t){super();this._canvas=t,this.fixedTickerRate=1e3/20,this.maxDeltatime=1e3/19,this._crosshairShow=!1,this.inputController=new ve(this._canvas,window,document,this),this._debugText=[],this._debugTextShort=[],this._lastButtonPressed=null,this._assets=new xe({models:{player:"/assets/models/player.gltf"}}),this._room=new Se,this._loaded=!1,this._started=!1}get crosshairShow(){return this._crosshairShow}set crosshairShow(t){t!==this._crosshairShow&&(this._crosshairShow,this.emit("crosshairUpdate",this.crosshairShow))}get debugText(){return this._debugText}get debugTextShort(){return this._debugTextShort}_getDebugPosition(t,e=10){return t.map(s=>Dt(s,e,3)).join(", ")}_getDebugRotation(t){return t.map(e=>Dt(e*(180/Math.PI),10,3)).join(", ")}_updateDebugText(){const t=this._rendering.camera,e=this._player;this._debugTextShort=[`${e.position.axis.map(s=>Math.floor(s)).join(", ")}`],this._debugText=[`player pos: ${this._getDebugPosition(e.position.axis)}`,`(${this._getDebugRotation(e.head.rotation.axis)})`,`cam pos: ${this._getDebugPosition(t.position.axis)}`,` (${this._getDebugRotation(t.rotation.axis)})`,`${(()=>{let s="";for(const i of Lt)s+=this.inputController.getInput(i)?Te[i]:"_";return s})()} ${this._lastButtonPressed}`,`${this.inputController.mouseLocked?"cam":"mus"} ${(()=>{const s=this.inputController.mouseLocked;let i="";return s?i+=this._getDebugPosition(this.inputController.getInput("camera").position.axis,7):i+=this._getDebugPosition(this.inputController.getInput("mouse").position.axis,7),i})()}`,...(()=>{const s=globalThis.ug13Watch,i=[];for(const a in s)if(Object.prototype.hasOwnProperty.call(s,a)){const r=s[a];i.push(`
    ${a}: ${r}`)}return i.unshift(`ug13Watch (${i.length}) = {`),i.push("}"),i})()]}get player(){return this._player}get loaded(){return this._loaded}get started(){return this._started}async load(t=()=>{}){if(M("info",["",`       ${ge(ae).split(`
`).join(`
       `)}`,"       /                ","  ####################  ","####                ####","####  ##        ##  ####","####  ##  ####  ##  ####","####                ####","  ####################  ","    ##            ##    ","    ##            ##    "].join(`
`)),t(0,2,"Loading settings","Checking"),await se(),t(1,2,"Loading settings","Saving"),await ie(),t(2,2,"Loading settings","Done"),t(0,1,"Setting up some things",""),E.debug.failLoad===!0)throw new Error("settings.debug.failLoad is true");this.frameTicker=new B({maxDeltaTime:this.maxDeltatime,method:U.RequestAnimationFrame});const e=E.performance.fixedTickerUndershoot;return e!==0?(this.fixedTicker=new B({method:U.Manual,rate:this.fixedTickerRate,undershoot:e,maxDeltaTime:this.maxDeltatime}),this.frameTicker.on("tick",()=>this.fixedTicker.manualCallback())):this.fixedTicker=new B({method:U.SetInterval,rate:this.fixedTickerRate,undershoot:e,maxDeltaTime:this.maxDeltatime}),this._rendering=new ke(this._canvas,this,this._assets,this._room),t(1,1,"Setting up some things","Done"),t(0,1,"Loading assets",""),await this._assets.loadAssets(t),t(0,1,"Setting up a bit more",""),this._player=new ne(this._assets.assets.models.player,this._room.world,this.inputController,this._rendering.camera,this),this._loaded=!0,this.emit("loaded"),t(1,1,"Done loading",""),this}async start(t){if(E.debug.failStart===!0)throw new Error("settings.debug.failStart is true");if(t(0,2,"Starting"),this._loaded===!1)throw new Error("Game can't start if it's not loaded.");t(0,2,"Starting","Setting up renderer"),await this._rendering.start(),t(1,2,"Starting","Setting up some things"),this.inputController.on("action1",i=>{i===!0&&this.inputController.lockPointer()}),this.inputController.on("pause",i=>{i===!0&&this.inputController.unlockPointer()}),this.inputController.listen(),this.inputController.on("buttonDown",i=>{this._lastButtonPressed=i.button}),this.frameTicker.start().on("tick",this._frameTick.bind(this)),this.fixedTicker.start().on("tick",this._fixedTick.bind(this)),this._updateSize(),window.addEventListener("resize",this._updateSize.bind(this));const e=new Y(new Nt(16777215,1,50));if(e.position.y=2,e.rendererObject.castShadow=!0,this._room.world.add(e),((i,a)=>{const r=new Y(new Yt(new Gt(...a),new Xt({color:16777215})));r.position.set(i),r.rendererObject.castShadow=!0,r.rendererObject.receiveShadow=!0,this._room.world.add(r)})([0,-1,0],[10,1,10]),this.inputController.on("debug",i=>{i===!0&&(E.debug.stats.show++,E.debug.stats.show>2&&(E.debug.stats.show=0)),oe()}),t(2,2,"Starting","Done"),E.debug.devSocket.enabled){let i=function(h=""){a!==!0&&t(0,1,"Connecting to dev socket",h)},a=!1;i();const r=Vt(`//${location.hostname}:3001`,{reconnectionAttempts:1});r.io.on("error",h=>{i(`Error connecting (${h})`),M("err!","failed to connect to dev socket:",h)}),r.io.on("reconnect_error",h=>{i(`Error reconnecting (${h})`),M("err!","failed to reconnect to dev socket:",h)}),r.io.on("reconnect_attempt",()=>{i("Attempting to reconnect"),M("info","attempting to reconnect to dev socket...")}),r.io.connect(),await new Promise(h=>{r.on("connected",()=>{h()}),r.io.on("reconnect_failed",()=>{setTimeout(()=>{a=!0,t(1,1,"Giving up!","You can disable this in settings by setting debug.devSocket.enabled to false"),M("err!","giving up connecting to dev socket"),setTimeout(()=>{h()},5e3)},2e3)})}),t(1,1,"Connecting to dev socket","Done")}return this._started=!0,this.emit("started"),this}async stop(){throw new Error("not implemented")}_updateSize(){this._rendering.updateSize()}_frameTick(t){this._updateDebugText(),this.emit("frameTick",t)}_fixedTick(t){this.emit("fixedTick",t)}_setup(){throw new Error("not implemented")}_loadAssets(){throw new Error("not implemented")}}class fe extends Y{constructor(){super(new Ht);this._fov=50}get aspect(){return this._rendererObject.aspect}set aspect(t){this._rendererObject.aspect=t}get fov(){return this._fov}set fov(t){this._rendererObject.fov=t}updateProjectionMatrix(){this._rendererObject.updateProjectionMatrix()}}class we extends Y{constructor(){super(...arguments);this._rendererObject=new Wt}get rendererObject(){return this._rendererObject}}class be extends et{constructor(t){super();this._element=t,this.ongoingTouches=[],this.ongoingTouchesDOM=[]}_setupEvents(){this._element.addEventListener("touchend",this._touchEndEvent.bind(this)),this._element.addEventListener("touchcancel",this._touchCancelEvent.bind(this)),this._element.addEventListener("touchmove",this._touchMoveEvent.bind(this)),this._element.addEventListener("touchstart",this._touchStartEvent.bind(this)),this.on("end",t=>this.emit("stop",t)),this.on("cancel",t=>this.emit("stop",t))}listen(){this._setupEvents()}_updateTouch(t,e){const s=this.ongoingTouches[t],i={id:t,rawTouch:e,movementX:s?e.clientX-s.rawTouch.clientX:0,movementY:s?e.clientY-s.rawTouch.clientY:0,posX:e.clientX,posY:e.clientY};return this.ongoingTouches[t]=i,this.ongoingTouchesDOM[e.identifier]=i,i}_deleteTouch(t){const e=this.ongoingTouches[t];return delete this.ongoingTouchesDOM[e.rawTouch.identifier],delete this.ongoingTouches[t],e}_createTouch(t){return this._updateTouch(this.ongoingTouches.length,t)}getDomId(t){var e;return(e=this.ongoingTouches[t])==null?void 0:e.rawTouch.identifier}getTouchControllerId(t){var e;return(e=this.ongoingTouchesDOM[t])==null?void 0:e.id}_touchStartEvent(t){t.preventDefault();for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];this.emit("start",this._createTouch(s))}}_touchEndEvent(t){t.preventDefault();for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];this.emit("end",this._deleteTouch(this.getTouchControllerId(s.identifier)))}}_touchCancelEvent(t){t.preventDefault();for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];this.emit("cancel",this._deleteTouch(this.getTouchControllerId(s.identifier)))}}_touchMoveEvent(t){t.preventDefault();for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];this.emit("move",this._updateTouch(this.getTouchControllerId(s.identifier),s))}}}const Lt=["jump","use","action1","action2","moveForwards","moveBackwards","moveLeft","moveRight","lookUp","lookDown","lookLeft","lookRight","pause","debug","fullscreen","zoom","changePerspective"],Te={action1:"1",action2:"2",camera:"C",debug:"D",jump:"J",mouse:"M",moveBackwards:"v",moveForwards:"^",moveLeft:"<",moveRight:">",lookDown:"v",lookLeft:"<",lookRight:">",lookUp:"^",pause:"P",use:"E",fullscreen:"F",zoom:"Z",changePerspective:"P"};class ve extends et{constructor(t,e=window,s=document,i){super();this._element=t,this._window=e,this._document=s,this._game=i,this.touchController=new be(this._element),this._cameraTouchId=null,this._mouseLocked=!1,this._inputs={mouse:{movement:new z,position:new z},camera:{movement:new z,position:new z}},this._assignmentToButtonCache=new re({},!1),this._buttons={}}get element(){return this._element}get window(){return this._window}get document(){return this._document}get cameraTouchId(){return this._cameraTouchId}listen(){var t;this._setupEvents(),this.touchController.listen(),this.touchController.on("start",e=>{this._cameraTouchId===null&&(this._cameraTouchId=e.id),this._pointerLockChange(!0)}),this.touchController.on("stop",e=>{e.id===this._cameraTouchId&&(this._cameraTouchId=null)}),this.touchController.on("move",e=>{e.id===this._cameraTouchId&&this._mouseMove(new z([e.movementX,e.movementY]).setMul(E.input.camera.touchSensitivity))}),(t=this._game)==null||t.on("frameTick",e=>{const s=new z,i=E.input.camera.keyboardSensitivity*e;this.getInput("lookDown")&&s.setAdd([0,i]),this.getInput("lookUp")&&s.setAdd([0,-i]),this.getInput("lookRight")&&s.setAdd([i,0]),this.getInput("lookLeft")&&s.setAdd([-i,0]),this._cameraMove(s)})}_setupEvents(){this._element.addEventListener("mousedown",this._mouseDown.bind(this)),this._element.addEventListener("mouseup",this._mouseUp.bind(this)),this._window.addEventListener("keydown",this._keyDown.bind(this)),this._window.addEventListener("keyup",this._keyUp.bind(this)),this._element.addEventListener("contextmenu",this._contextMenu.bind(this)),this._window.addEventListener("blur",this._unfocus.bind(this)),this._window.addEventListener("mousemove",this._mouseMoveEvent.bind(this)),this._document.addEventListener("pointerlockchange",this._pointerLockChangeEvent.bind(this))}get mouseLocked(){return this._mouseLocked}_pointerLockChangeEvent(t){this._pointerLockChange()}_pointerLockChange(t=this.document.pointerLockElement===this._element){this._mouseLocked=t,this.emit("mouseLock",t)}get inputs(){return this._inputs}_mouseNumberToString(t){return`Mouse${t}`}_mouseDown(t){t.preventDefault(),this._buttonDown(this._mouseNumberToString(t.button))}_contextMenu(t){return t.preventDefault(),!1}_unfocus(){for(const t in this._inputs)Object.prototype.hasOwnProperty.call(this._inputs,t)&&Lt.includes(t)&&this._processButtonInputEvent(t,!1)}_mouseUp(t){t.preventDefault(),this._buttonUp(this._mouseNumberToString(t.button))}_keyDown(t){t.preventDefault(),this._buttonDown(t.code)}_keyUp(t){t.preventDefault(),this._buttonUp(t.code)}_buttonDown(t){this._processButtonEvent(t,!0)}_buttonUp(t){this._processButtonEvent(t,!1)}_processButtonInputEvent(t,e,s=E.input[t]){const i={button:s,mapped:t};e===!0?this.emit("buttonDown",i):this.emit("buttonUp",i),t!=="none"&&(this._inputs[t]=e,this.emit(t,e))}_getButtonInputFromButton(t){return this._assignmentToButtonCache.do(t,()=>{const e=E.input.keys;for(const s in e)if(Object.prototype.hasOwnProperty.call(e,s)&&e[s]===t)return s;return"none"})}_processButtonEvent(t,e){if(this._buttons[t]===e)return;this._buttons[t]=e;const s=this._getButtonInputFromButton(t);this._processButtonInputEvent(s,e,t)}_cameraMove(t){this._inputs.camera.movement.set(t),this._inputs.camera.position.setAdd(t),this.emit("camera",this._inputs.camera)}_mouseMoveEvent(t){this._mouseMove(new z([t.movementX,t.movementY]),new z([t.clientX,t.clientY]))}_mouseMove(t,e){this._inputs.mouse.movement.set(t),e?this._inputs.mouse.position.set(e):this._inputs.mouse.position.add(t),this._mouseLocked===!0&&this._cameraMove(this._inputs.mouse.movement),this.emit("mouse",this._inputs.mouse)}lockPointer(){this._element.requestPointerLock()}unlockPointer(){this._document.exitPointerLock()}getButtonDown(t){return this._buttons[t]===!0}getInput(t){const e=this._inputs[t];return e===void 0?!1:e}_removeEvents(){}}class ke{constructor(t,e,s,i){this._canvas=t,this._game=e,this._assets=s,this._room=i,this._canvasContext=this._canvas.getContext("webgl"),this.camera=new fe,this._resolution=1,this._room.world.add(this.camera)}set resolution(t){this._resolution=t,this.updateSize()}get resolution(){return this._resolution}setupRenderer(){M("dbug","setting up renderer..."),this._renderer=new Jt({context:this._canvasContext,antialias:!1}),M("dbug","done setting up renderer.")}_updateShadowMap(){this._renderer.shadowMap.needsUpdate=!0}async start(){return this.setupRenderer(),this.updateSize(),this._room.world.rendererObject.background=new qt(2236962),ot(t=>{this._renderer.shadowMap.enabled=t.video.shadows.enabled,t.video.shadows.reduceShadowUpdates===!0?(this._renderer.shadowMap.autoUpdate=!1,this._game.on("fixedTick",this._updateShadowMap.bind(this))):this._game.off("fixedTick",this._updateShadowMap.bind(this))}),this._game.on("frameTick",this._frameTick.bind(this)),this}_frameTick(){this._renderer.render(this._room.world.rendererObject,this.camera.rendererObject)}updateSize(){const t=innerWidth*this._resolution,e=innerHeight*this._resolution;return this._canvas.width=t,this._canvas.height=e,this._renderer.setSize(t,e),this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this}}class xe{constructor(t){this._assetsInput=t,this.assets={models:{},images:{}}}async loadAssets(t){await this._loadAssets(t)}async _loadAssets(t){M("dbug","loading assets...");function e(r,h){let _=0,l=0;for(const m of s)m.loaded>m.total?(_+=m.total,M("warn",`an asset's amount loaded is more than its total! (${m.loaded}/${m.total})`)):_+=m.loaded,l+=m.total;t==null||t(_,l,"Downloading assets",`${h} ${r}`)}const s=[],i=this._assetsInput.models;for(const r in i)if(Object.prototype.hasOwnProperty.call(i,r)){const h=i[r],_=Zt.extname(h);let l;switch(_){case".gltf":l=Qt}if(l!==void 0){const m=new l,g={promise:async()=>{const d=await m.loadAsync(h,o=>{g.loaded=o.loaded,g.total=o.total,e("model",_)});return Y.rendererObjectToJSON(d.scene)},loaded:0,total:0};typeof g.promise=="function"&&(g.promise=g.promise()),g.promise.then(d=>{this.assets.models[r]=d}),s.push(g)}else{const m=new Error(`Unknown file type ${_} (${r})`);throw M("err!",m.message),m}}const a=s.map(r=>r.promise);await Promise.all(a),M("dbug","done loading assets",this.assets)}}class Se{constructor(){this.world=new we}}function Ct(n,t,e){const s=n.slice();return s[7]=t[e],s}function Pt(n,t,e){const s=n.slice();return s[10]=t[e],s[12]=e,s}function It(n){let t,e,s,i,a,r,h,_=n[1],l=[];for(let o=0;o<_.length;o+=1)l[o]=At(Pt(n,_,o));const m=o=>j(l[o],1,1,()=>{l[o]=null});let g=n[0]?n[3]:n[4],d=[];for(let o=0;o<g.length;o+=1)d[o]=Rt(Ct(n,g,o));return{c(){t=x("div"),e=x("div");for(let o=0;o<l.length;o+=1)l[o].c();s=I(),i=x("div");for(let o=0;o<d.length;o+=1)d[o].c();this.h()},l(o){t=S(o,"DIV",{class:!0});var c=y(t);e=S(c,"DIV",{class:!0});var u=y(e);for(let w=0;w<l.length;w+=1)l[w].l(u);u.forEach(f),s=A(c),i=S(c,"DIV",{class:!0});var b=y(i);for(let w=0;w<d.length;w+=1)d[w].l(b);b.forEach(f),c.forEach(f),this.h()},h(){v(e,"class","panels svelte-1xg1opo"),v(i,"class","text svelte-1xg1opo"),v(t,"class",a="container "+(n[0]?"":"hidden")+" svelte-1xg1opo")},m(o,c){P(o,t,c),T(t,e);for(let u=0;u<l.length;u+=1)l[u].m(e,null);T(t,s),T(t,i);for(let u=0;u<d.length;u+=1)d[u].m(i,null);h=!0},p(o,c){if(n=o,c&3){_=n[1];let u;for(u=0;u<_.length;u+=1){const b=Pt(n,_,u);l[u]?(l[u].p(b,c),L(l[u],1)):(l[u]=At(b),l[u].c(),L(l[u],1),l[u].m(e,null))}for(pt(),u=_.length;u<l.length;u+=1)m(u);ft()}if(c&25){g=n[0]?n[3]:n[4];let u;for(u=0;u<g.length;u+=1){const b=Ct(n,g,u);d[u]?d[u].p(b,c):(d[u]=Rt(b),d[u].c(),d[u].m(i,null))}for(;u<d.length;u+=1)d[u].d(1);d.length=g.length}(!h||c&1&&a!==(a="container "+(n[0]?"":"hidden")+" svelte-1xg1opo"))&&v(t,"class",a)},i(o){if(!h){for(let c=0;c<_.length;c+=1)L(l[c]);$t(()=>{r||(r=wt(t,kt,{duration:200,easing:vt},!0)),r.run(1)}),h=!0}},o(o){l=l.filter(Boolean);for(let c=0;c<l.length;c+=1)j(l[c]);r||(r=wt(t,kt,{duration:200,easing:vt},!1)),r.run(0),h=!1},d(o){o&&f(t),bt(l,o),bt(d,o),o&&r&&r.end()}}}function At(n){let t,e,s,i,a,r;return e=new de({props:{panel:n[10],compact:!n[0]}}),{c(){t=x("div"),Q(e.$$.fragment),s=I(),this.h()},l(h){t=S(h,"DIV",{class:!0});var _=y(t);K(e.$$.fragment,_),s=A(_),_.forEach(f),this.h()},h(){v(t,"class","panel "+(n[12]===0?"top":"")+" svelte-1xg1opo")},m(h,_){P(h,t,_),$(e,t,null),T(t,s),i=!0,a||(r=Kt(t,"click",n[6]),a=!0)},p(h,_){const l={};_&2&&(l.panel=h[10]),_&1&&(l.compact=!h[0]),e.$set(l)},i(h){i||(L(e.$$.fragment,h),i=!0)},o(h){j(e.$$.fragment,h),i=!1},d(h){h&&f(t),tt(e),a=!1,r()}}}function Rt(n){let t,e=n[7]+"",s;return{c(){t=x("span"),s=J(e),this.h()},l(i){t=S(i,"SPAN",{class:!0});var a=y(t);s=q(a,e),a.forEach(f),this.h()},h(){v(t,"class","line svelte-1xg1opo")},m(i,a){P(i,t,a),T(t,s)},p(i,a){a&25&&e!==(e=i[7]+"")&&it(s,e)},d(i){i&&f(t)}}}function ye(n){let t,e,s=n[2]&&It(n);return{c(){s&&s.c(),t=Tt()},l(i){s&&s.l(i),t=Tt()},m(i,a){s&&s.m(i,a),P(i,t,a),e=!0},p(i,[a]){i[2]?s?(s.p(i,a),a&4&&L(s,1)):(s=It(i),s.c(),L(s,1),s.m(t.parentNode,t)):s&&(pt(),j(s,1,1,()=>{s=null}),ft())},i(i){e||(L(s),e=!0)},o(i){j(s),e=!1},d(i){s&&s.d(i),i&&f(t)}}}function Me(n,t,e){let{open:s=!1}=t,{active:i=!1}=t,{panels:a=[]}=t,{text:r=[]}=t,{textClosed:h=[]}=t;function _(m){e(1,a=[...a,m])}const l=m=>{m.preventDefault(),e(0,s=!s)};return n.$$set=m=>{"open"in m&&e(0,s=m.open),"active"in m&&e(2,i=m.active),"panels"in m&&e(1,a=m.panels),"text"in m&&e(3,r=m.text),"textClosed"in m&&e(4,h=m.textClosed)},[s,a,i,r,h,_,l]}class Ee extends X{constructor(t){super();H(this,t,Me,ye,W,{open:0,active:2,panels:1,text:3,textClosed:4,addPanel:5})}get addPanel(){return this.$$.ctx[5]}}class jt extends Et{constructor(...t){super(...t);this._lowestThisSection=1/0,this._highestThisSection=0,this._TPSTicker=new B({method:U.Manual,rate:1e3}),this.showExtras=!0,this._updateText=!1,this._TPSTicker.start(),this.on("update",(e,s,i)=>{this._lowestThisSection>i?this._lowestThisSection=i:this._highestThisSection<i&&(this._highestThisSection=i),this._TPSTicker.manualCallback()}),this._TPSTicker.on("tick",()=>this.updateText())}updateText(){this.text="";function t(s){return typeof s=="number"?Math.floor(s):s}const e=`${t(this._lowestThisSection)}/${t(this._highestThisSection)}`;this.compactText=`${e} ${this.unit}`,this.text=`${e} ${this.unit}
(${t(this._min)} - ${t(this._max)})`,this._lowestThisSection=1/0,this._highestThisSection=0}}function De(n){let t,e,s,i,a,r,h,_,l;i=new he({props:{show:n[4],info:n[2],percent:n[3],title:n[1],error:n[5],logs:n[6],showLogs:Le,suggestLogs:n[7]}});function m(o){n[16](o)}function g(o){n[17](o)}let d={text:n[11],textClosed:n[12]};return n[10]!==void 0&&(d.open=n[10]),n[9]!==void 0&&(d.active=n[9]),r=new Ee({props:d}),n[15](r),N.push(()=>xt(r,"open",m)),N.push(()=>xt(r,"active",g)),{c(){t=x("main"),e=x("canvas"),s=I(),Q(i.$$.fragment),a=I(),Q(r.$$.fragment),this.h()},l(o){t=S(o,"MAIN",{class:!0});var c=y(t);e=S(c,"CANVAS",{id:!0,class:!0}),y(e).forEach(f),s=A(c),K(i.$$.fragment,c),a=A(c),K(r.$$.fragment,c),c.forEach(f),this.h()},h(){v(e,"id","canvas"),v(e,"class","svelte-1nlk8s4"),v(t,"class","svelte-1nlk8s4"),Z(t,"noSelect",n[13])},m(o,c){P(o,t,c),T(t,e),n[14](e),T(t,s),$(i,t,null),T(t,a),$(r,t,null),l=!0},p(o,[c]){const u={};c&16&&(u.show=o[4]),c&4&&(u.info=o[2]),c&8&&(u.percent=o[3]),c&2&&(u.title=o[1]),c&32&&(u.error=o[5]),c&64&&(u.logs=o[6]),c&128&&(u.suggestLogs=o[7]),i.$set(u);const b={};c&2048&&(b.text=o[11]),c&4096&&(b.textClosed=o[12]),!h&&c&1024&&(h=!0,b.open=o[10],St(()=>h=!1)),!_&&c&512&&(_=!0,b.active=o[9],St(()=>_=!1)),r.$set(b),c&8192&&Z(t,"noSelect",o[13])},i(o){l||(L(i.$$.fragment,o),L(r.$$.fragment,o),l=!0)},o(o){j(i.$$.fragment,o),j(r.$$.fragment,o),l=!1},d(o){o&&f(t),n[14](null),tt(i),n[15](null),tt(r)}}}let Le=!0;function Ce(n,t,e){mt(()=>{});let s,i="Downloading webpage",a="",r=0,h=!0,_=!0,l=!1,m=[],g=!0,d,o=!1,c=!1,u=[],b=[];_t(()=>{(async()=>{ot(p=>{switch(p.debug.stats.show){case at.No:e(9,o=!1),e(10,c=!1);break;case at.Collapsed:e(9,o=!0),e(10,c=!1);break;case at.Open:e(9,o=!0),e(10,c=!0);break}e(13,w=p.video.noSelect),e(7,g=p.debug.logging.hideLoadingLogs)});const k=new jt("Frame TPS","#0FF","#022"),ht=new jt("Fixed TPS","#FF0","#220"),D=new Et("Memory","#F0F","#202");d.addPanel(k),d.addPanel(ht),d.addPanel(D),D.unit="MB";function lt(p){return Math.floor(1e3/p)}function Bt(){if(performance.memory){D.update(performance.memory.usedJSHeapSize*1e-6),D.showExtras=!0;const p=performance.memory.usedJSHeapSize/performance.memory.jsHeapSizeLimit;D.dynamicMax=!0,D.unstable=p>.5,D.unstableText=`${Math.floor(p*100)}% usage`}else D.update(`???
No memory
support`),D.dynamicMax=!1,D.showExtras=!1}k.dynamicMax=!0;function ct(p,C,G,st){p.update(lt(G),st),p.unstable=C!==G,p.unstableText=`faking ${lt(C)}TPS`}const O=new pe(s);function ut(p){e(6,m=[...m,p])}yt.on("outputNotLeveled",ut.bind(this)),O.on("started",()=>{_!==!1&&(e(4,h=!1),e(1,i="Done"),e(2,a=""),_=!1)});function dt(p,C,G,st){_!==!1&&(e(3,r=p/C),e(1,i=G),e(2,a=st),M("dbug","loading update: "+i+((a!=null?a:!1)?` (${a})`:"")+` ${Math.floor(r*100)}%`))}try{await O.load(dt.bind(this)),await O.start(dt.bind(this))}catch(p){e(1,i="Failed"),e(2,a=`${p}`),_=!1,e(5,l=!0),M("err!","error loading/starting game:",p),e(7,g=!1);return}yt.off("output",ut.bind(this)),O.frameTicker.on("tick",(p,C)=>{ct(k,p,C),e(11,u=O.debugText),e(12,b=O.debugTextShort)}),O.fixedTicker.on("tick",(p,C)=>{ct(ht,p,C,20),Bt()})})()});let w=!1;function F(k){N[k?"unshift":"push"](()=>{s=k,e(0,s)})}function rt(k){N[k?"unshift":"push"](()=>{d=k,e(8,d)})}function zt(k){c=k,e(10,c)}function Ot(k){o=k,e(9,o)}return[s,i,a,r,h,l,m,g,d,o,c,u,b,w,F,rt,zt,Ot]}class Pe extends X{constructor(t){super();H(this,t,Ce,De,W,{})}}function Ie(n){let t,e,s;return e=new Pe({}),{c(){t=I(),Q(e.$$.fragment),this.h()},l(i){te('[data-svelte="svelte-4vcxiu"]',document.head).forEach(f),t=A(i),K(e.$$.fragment,i),this.h()},h(){document.title="..."},m(i,a){P(i,t,a),$(e,i,a),s=!0},p:nt,i(i){s||(L(e.$$.fragment,i),s=!0)},o(i){j(e.$$.fragment,i),s=!1},d(i){i&&f(t),tt(e,i)}}}class je extends X{constructor(t){super();H(this,t,null,Ie,W,{})}}export{je as default};
