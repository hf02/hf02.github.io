import{K as Ye,S as X,i as G,s as H,e as S,t as q,c as y,a as M,g as J,d as f,b as k,f as R,P as b,h as ae,j as A,l as j,U as O,N as Z,Y as re,u as pe,Z as fe,_ as We,$ as V,a0 as Xe,a1 as we,a2 as Ge,a3 as He,a4 as qe,a5 as Je,a6 as Ze,a7 as Ke,a8 as Qe,a9 as $e,aa as et,ab as tt,X as st,ac as it,p as P,v as K,w as Q,x as $,ad as nt,n as z,A as ee,m as ve,o as be,Q as ot,R as Te,T as ke,k as xe,V as Se,W as ye,ae as Me,af as Ee,F as at}from"../chunks/vendor-d648d7c7.js";import{T as te,a as U,b as F,d as he,S as Y,V as rt,l as E,w as ht,g as De,s as Pe,c as T,P as lt,e as B,C as ct,L as ut,f as le,h as Le}from"../chunks/generateWelcomeMessage-590a965f.js";function dt(n,e,t){return n.padEnd(t,e).slice(0,t)}function Ce(n){let e,t,s,i;return{c(){e=S("div"),t=q("! "),s=q(n[7]),this.h()},l(r){e=y(r,"DIV",{class:!0});var a=M(e);t=J(a,"! "),s=J(a,n[7]),a.forEach(f),this.h()},h(){k(e,"class",i="unstable "+(n[5]?"cooldown":"")+" svelte-1cip8ko")},m(r,a){R(r,e,a),b(e,t),b(e,s)},p(r,a){a&128&&ae(s,r[7]),a&32&&i!==(i="unstable "+(r[5]?"cooldown":"")+" svelte-1cip8ko")&&k(e,"class",i)},d(r){r&&f(e)}}}function _t(n){let e,t,s,i,r,a=(n[1]?n[3]:`${n[4]}
${n[3]}`)+"",l,_,h,m,g=(n[6]===!0||n[5]===!0)&&Ce(n);return{c(){e=S("div"),t=S("div"),s=S("div"),i=A(),r=S("div"),l=q(a),_=A(),h=S("canvas"),m=A(),g&&g.c(),this.h()},l(c){e=y(c,"DIV",{class:!0,style:!0});var o=M(e);t=y(o,"DIV",{class:!0});var u=M(t);s=y(u,"DIV",{class:!0,style:!0}),M(s).forEach(f),i=j(u),r=y(u,"DIV",{class:!0});var d=M(r);l=J(d,a),d.forEach(f),u.forEach(f),_=j(o),h=y(o,"CANVAS",{class:!0}),M(h).forEach(f),m=j(o),g&&g.l(o),o.forEach(f),this.h()},h(){k(s,"class","text-background svelte-1cip8ko"),O(s,"background","linear-gradient(180deg, "+n[0].bg+" 35%, #00000000 100%)"),k(r,"class","text-content svelte-1cip8ko"),k(t,"class","text svelte-1cip8ko"),k(h,"class","svelte-1cip8ko"),k(e,"class","panel svelte-1cip8ko"),O(e,"background-color",n[0].bg),O(e,"border-color",n[0].fg),O(e,"color",n[0].fg),Z(e,"compact",n[1])},m(c,o){R(c,e,o),b(e,t),b(t,s),b(t,i),b(t,r),b(r,l),b(e,_),b(e,h),n[8](h),b(e,m),g&&g.m(e,null)},p(c,[o]){o&1&&O(s,"background","linear-gradient(180deg, "+c[0].bg+" 35%, #00000000 100%)"),o&26&&a!==(a=(c[1]?c[3]:`${c[4]}
${c[3]}`)+"")&&ae(l,a),c[6]===!0||c[5]===!0?g?g.p(c,o):(g=Ce(c),g.c(),g.m(e,null)):g&&(g.d(1),g=null),o&1&&O(e,"background-color",c[0].bg),o&1&&O(e,"border-color",c[0].fg),o&1&&O(e,"color",c[0].fg),o&2&&Z(e,"compact",c[1])},i:re,o:re,d(c){c&&f(e),n[8](null),g&&g.d()}}}class se extends te{constructor(e,t,s){super();this.name=e,this.fg=t,this.bg=s,this._min=1/0,this._max=0,this.graph_x=0,this.graph_y=0,this.graph_width=100,this.graph_total_height=70,this.graph_deadzone=50,this.graph_non_deadzone=this.graph_total_height-this.graph_deadzone,this._updateText=!0,this.dynamicMax=!1,this._alreadyUpdatedDynamicMax=!1,this._currentDynamicMax=0,this._dynamicMaxTicker=new U({method:F.Manual,rate:1e4}),this._dynamicMaxStartTicker=new U({method:F.Manual,rate:1e3}),this.showExtras=!0,this._last=[],this._average=0,this._viewAverage=0,this.unit="",this.text="",this.compactText="",this._unstable=!1,this._unstableCooldown=!1,this._unstableText="",this.updateCanvas(),this._dynamicMaxTicker.on("tick",()=>this.updateDynamicTick()),this._dynamicMaxTicker.start(),this._dynamicMaxStartTicker.once("tick",()=>{this._dynamicMaxStartTicker.stop(),this.updateDynamicTick()}),this._dynamicMaxStartTicker.start()}updateSize(){this._pixelRatio=1,this._graph_x=this.graph_x*this._pixelRatio,this._graph_y=this.graph_y*this._pixelRatio,this._graph_width=this.graph_width*this._pixelRatio,this._graph_height=this.graph_deadzone*this._pixelRatio,this._graph_deadzone=this.graph_non_deadzone*this._pixelRatio,this._graph_deadzone_percent=this._graph_deadzone/(this._graph_height+this._graph_deadzone),this._canvas.width=this._graph_width,this._canvas.height=this.graph_total_height}updateCanvas(e=document.createElement("canvas")){this._canvas=e,this._context=this._canvas.getContext("2d"),this.updateSize()}rerenderAll(e=this._last,t=this._average){for(let s=0;s<e.length;s++){const i=e[s];this.render(i,t)}}render(e,t=this._average,s=this.fg,i=this.bg){if(typeof e=="number"){this._context.drawImage(this._canvas,this._graph_x+this._pixelRatio,this._graph_y,this._graph_width-this._pixelRatio,this._graph_height+this._graph_deadzone,this._graph_x,this._graph_y,this._graph_width-this._pixelRatio,this._graph_height+this._graph_deadzone),this._context.fillStyle=s;const r=Math.floor(e/t*(this._graph_height+this._graph_deadzone));this._context.fillRect(this._graph_x+this._graph_width-this._pixelRatio,this._graph_y,this._pixelRatio,this._graph_height+this._graph_deadzone);const a=r*this._graph_deadzone_percent;this._context.fillStyle=i,this._context.fillRect(this._graph_x+this._graph_width-this._pixelRatio,this._graph_y,this._pixelRatio,this._graph_height+this._graph_deadzone-a)}}updateDynamicTick(){this._currentDynamicMax=this._average,this._alreadyUpdatedDynamicMax=!0,this.dynamicMax===!0&&this.render(10,1,"#FFF")}update(e,t=this._currentDynamicMax){if(this._last.push(e),this._last.length>this._graph_width&&this._last.shift(),this._average=Math.round(Ye.mean(this._last)),this._viewAverage<this._average?this._viewAverage++:this._viewAverage>this._average&&this._viewAverage--,(this._alreadyUpdatedDynamicMax||!this.dynamicMax)&&this.render(e,t),typeof e=="number"&&(this._min=Math.min(this._min,e),this._max=Math.max(this._max,e)),this._dynamicMaxTicker.manualCallback(),this._dynamicMaxStartTicker.manualCallback(),this._updateText){let s=function(i){return typeof i=="number"?Math.floor(i):i};this.showExtras===!1?(this.text=`${s(e)}`,this.compactText=this.text):(this.compactText=`${s(e)} ${this.unit}`,this.text=`${s(e)} ${this.unit}
(${s(this._min)} - ${s(this._max)})`)}this.emit("update",this._min,this._max,e)}get unstable(){return this._unstable}set unstable(e){e===!1&&this._unstable===!0&&(this._unstableCooldown=!0,clearTimeout(this._unstableCooldownTimeout),this._unstableCooldownTimeout=setTimeout(()=>{this._unstableCooldown=!1},5e3)),e===!0&&(clearTimeout(this._unstableCooldownTimeout),this._unstableCooldown=!1),this._unstable=e}get unstableCooldown(){return this._unstableCooldown}set unstableText(e){this.unstable&&(this._unstableText=e)}get unstableText(){return this._unstableText}}function mt(n,e,t){let{panel:s}=e,i,r="",a="",l;const _=he(w=>{const N=w.debug.stats.spinner;switch(N){case Y.Braille:l=["\u2807","\u280B","\u2819","\u2838","\u2834","\u2826"];break;case Y.Line:l=["/","-","\\","|"];break;case Y.Number:l=["0","1","2","3","4","5","6","7","8","9"];break;case Y.Wiggle:l=["<","(","|",")",">",")","|","("];break;case Y.Run:l=["\u2514(\u141B)\u2510","\u250C(\u141B)\u2518"];break;default:l=N;break}});let h=0;function m(w,N,ce){c?t(3,r=`${l[h%l.length]} ${s.compactText}`):t(3,r=`${l[h%l.length]} ${s.text}`),h++,t(4,a=s.name),t(6,u=s.unstable),t(7,d=s.unstableText),t(5,o=s.unstableCooldown)}pe(()=>{s.updateCanvas(i),m(),s.on("update",m)});function g(){s.removeListener("update",m),_(),t(0,s=null)}fe(g);let{compact:c=!1}=e,o=!1,u=!1,d="";function v(w){V[w?"unshift":"push"](()=>{i=w,t(2,i)})}return n.$$set=w=>{"panel"in w&&t(0,s=w.panel),"compact"in w&&t(1,c=w.compact)},n.$$.update=()=>{n.$$.dirty&1&&new We(s.bg).alpha(.5).string()},[s,c,i,r,a,o,u,d,v]}class gt extends X{constructor(e){super();G(this,e,mt,_t,H,{panel:0,compact:1})}}function Ie(n,e,t=0){const s=Math.abs(n),i=s.toFixed();`${s}`.length-i.length;let r=i.length+t;const a=e;let l=!1;for(;r<a;){const h=s.toPrecision(r);if(h.length>=a){t===0&&h.indexOf(".")&&h.length>a&&(l=!0);break}r++}const _=n.toPrecision(r);return l?dt(_,"0",e):_}function pt(n,e){let t=null;return(...s)=>new Promise(i=>{if(t!==null){i();return}t=setTimeout(()=>{t=null,i(n(...s))},e)})}class L extends rt{constructor(e){super(e,2)}get x(){return this.getAxis(0)}set x(e){this.setAxis(0,e)}get y(){return this.getAxis(1)}set y(e){this.setAxis(1,e)}}class ft extends te{constructor(e){super();this._canvas=e,this.fixedTickerRate=1e3/20,this.maxDeltatime=1e3/19,this._crosshairShow=!1,this.inputController=new kt(this._canvas,window,document,this),this._debugText=[],this._debugTextShort=[],this._lastButtonPressed=null,this._assets=new St({models:{player:"/assets/models/player.json"}}),this._room=new yt,this._loaded=!1,this._started=!1}get crosshairShow(){return this._crosshairShow}set crosshairShow(e){e!==this._crosshairShow&&(this._crosshairShow,this.emit("crosshairUpdate",this.crosshairShow))}get debugText(){return this._debugText}get debugTextShort(){return this._debugTextShort}get devSocket(){return this._devSocket}get rendering(){return this._rendering}_getDebugPosition(e,t=10){return e.map(s=>Ie(s,t,3)).join(", ")}_getDebugRotation(e){return e.map(t=>Ie(t,10,3)).join(", ")}_updateDebugText(){const e=this._rendering.camera,t=this._player;this._debugTextShort=[`${t.position.axis.map(s=>Math.floor(s)).join(", ")}`],this._debugText=[`player pos: ${this._getDebugPosition(t.position.axis)}`,`(${this._getDebugRotation(t.head.rotation.degrees.axis)})`,`cam pos: ${this._getDebugPosition(e.position.axis)}`,` (${this._getDebugRotation(e.rotation.degrees.axis)})`,`${(()=>{let s="";for(const i of Re)s+=this.inputController.getInput(i)?Tt[i]:"_";return s})()} ${this._lastButtonPressed}`,`${this.inputController.mouseLocked?"cam":"mus"} ${(()=>{const s=this.inputController.mouseLocked;let i="";return s?i+=this._getDebugPosition(this.inputController.getInput("camera").position.axis,7):i+=this._getDebugPosition(this.inputController.getInput("mouse").position.axis,7),i})()}`,...(()=>{const s=globalThis.ug13Watch,i=[];for(const r in s)if(Object.prototype.hasOwnProperty.call(s,r)){const a=s[r];i.push(`
    ${r}: ${a}`)}return i.unshift(`ug13Watch (${i.length}) = {`),i.push("}"),i})()]}get player(){return this._player}get loaded(){return this._loaded}get started(){return this._started}async load(e=()=>{}){if(E("info",`
${ht}`),e(0,2,"Loading settings","Checking"),await De(),e(1,2,"Loading settings","Saving"),await Pe(),e(2,2,"Loading settings","Done"),e(0,1,"Setting up some things",""),T.debug.failLoad===!0)throw new Error("settings.debug.failLoad is true");this.frameTicker=new U({maxDeltaTime:this.maxDeltatime,method:F.RequestAnimationFrame});const t=T.performance.fixedTickerUndershoot;return t!==0?(this.fixedTicker=new U({method:F.Manual,rate:this.fixedTickerRate,undershoot:t,maxDeltaTime:this.maxDeltatime}),this.frameTicker.on("tick",()=>this.fixedTicker.manualCallback())):this.fixedTicker=new U({method:F.SetInterval,rate:this.fixedTickerRate,undershoot:t,maxDeltaTime:this.maxDeltatime}),this._rendering=new xt(this._canvas,this,this._assets,this._room),e(1,1,"Setting up some things","Done"),e(0,1,"Loading assets",""),await this._assets.loadAssets(e),e(0,1,"Setting up a bit more",""),this._player=new lt(this._assets.assets.models.player,this._room.world,this.inputController,this._rendering.camera,this),this._loaded=!0,this.emit("loaded"),e(1,1,"Done loading",""),this}async start(e){if(T.debug.failStart===!0)throw new Error("settings.debug.failStart is true");if(e(0,2,"Starting"),this._loaded===!1)throw new Error("Game can't start if it's not loaded.");if(e(0,2,"Starting","Setting up renderer"),await this._rendering.start(),e(1,2,"Starting","Setting up some things"),this.inputController.on("action1",a=>{a===!0&&this.inputController.lockPointer()}),this.inputController.on("pause",a=>{a===!0&&this.inputController.unlockPointer()}),this.inputController.listen(),this.inputController.on("buttonDown",a=>{this._lastButtonPressed=a.button}),this.frameTicker.start().on("tick",this._frameTick.bind(this)),this.fixedTicker.start().on("tick",this._fixedTick.bind(this)),this._updateSize(),window.addEventListener("resize",this._updateSize.bind(this)),this.inputController.on("debug",a=>{a===!0&&(T.debug.stats.show++,T.debug.stats.show>2&&(T.debug.stats.show=0),Pe())}),e(2,2,"Starting","Done"),T.debug.devSocket.enabled){let a=function(h=""){l!==!0&&e(0,1,"Setting up dev socket",h)},l=!1;a("Requesting server to start websocket"),await fetch("/dev/start"),a(),this._devSocket=Xe(`//${location.hostname}:3001`,{reconnectionAttempts:1}),this._devSocket.io.on("error",h=>{a(`Error connecting (${h})`),E("err!","failed to connect to dev socket:",h)}),this._devSocket.io.on("reconnect_error",h=>{a(`Error reconnecting (${h})`),E("err!","failed to reconnect to dev socket:",h)}),this._devSocket.io.on("reconnect_attempt",()=>{a("Attempting to reconnect"),E("info","attempting to reconnect to dev socket...")});const _=new Promise(h=>{this._devSocket.on("connect",()=>{h()}),this._devSocket.io.on("reconnect_failed",()=>{setTimeout(()=>{l=!0,e(1,1,"Skipping","You can disable this in settings by setting debug.devSocket.enabled to false"),E("err!","giving up connecting to dev socket"),setTimeout(()=>{h()},5e3)},2e3)})});if(a("Connecting"),this._devSocket.io.connect(),await _,e(0,1,"Connecting to dev socket","Setting up dev socket features"),T.debug.devSocket.liveStorageReload.enabled===!0){const h=pt(()=>De(),T.debug.devSocket.liveStorageReload.delay);this._devSocket.on("storageUpdate",()=>{h()})}e(1,1,"Connecting to dev socket","Done")}const t=new B(new we(16777215,.6,50));t.position.set([2,2,-5]),t.rendererObject.castShadow=!0;const s=new B(new we(16777215,.6,50));s.position.set([-2,2,-5]),s.rendererObject.castShadow=!0,this._room.world.add(t),this._room.world.add(s),((a,l)=>{const _=new B(new qe(new Je(...l),new Ze({color:16777215})));_.position.set(a),_.rendererObject.castShadow=!0,_.rendererObject.receiveShadow=!0,this._room.world.add(_)})([0,-.5,0],[10,1,10]);const r=new Ge(new He(5,5),{color:16777215,textureHeight:window.innerHeight,textureWidth:window.innerWidth});return r.position.set(0,0,-5),this._room.world.rendererObject.add(r),this._started=!0,this.emit("started"),this}async stop(){throw new Error("not implemented")}_updateSize(){this._rendering.updateSize()}_frameTick(e){this._updateDebugText(),this.emit("frameTick",e)}_fixedTick(e){this.emit("fixedTick",e)}_setup(){throw new Error("not implemented")}_loadAssets(){throw new Error("not implemented")}}class wt extends B{constructor(){super(new Ke);this._fov=50}get aspect(){return this._rendererObject.aspect}set aspect(e){this._rendererObject.aspect=e}get fov(){return this._fov}set fov(e){this._rendererObject.fov=e}updateProjectionMatrix(){this._rendererObject.updateProjectionMatrix()}}class vt extends B{constructor(){super(...arguments);this._rendererObject=new Qe}get rendererObject(){return this._rendererObject}}class bt extends te{constructor(e){super();this._element=e,this.ongoingTouches=[],this.ongoingTouchesDOM=[]}_setupEvents(){this._element.addEventListener("touchend",this._touchEndEvent.bind(this)),this._element.addEventListener("touchcancel",this._touchCancelEvent.bind(this)),this._element.addEventListener("touchmove",this._touchMoveEvent.bind(this)),this._element.addEventListener("touchstart",this._touchStartEvent.bind(this)),this.on("end",e=>this.emit("stop",e)),this.on("cancel",e=>this.emit("stop",e))}listen(){this._setupEvents()}_updateTouch(e,t){const s=this.ongoingTouches[e],i={id:e,rawTouch:t,movementX:s?t.clientX-s.rawTouch.clientX:0,movementY:s?t.clientY-s.rawTouch.clientY:0,posX:t.clientX,posY:t.clientY};return this.ongoingTouches[e]=i,this.ongoingTouchesDOM[t.identifier]=i,i}_deleteTouch(e){const t=this.ongoingTouches[e];return delete this.ongoingTouchesDOM[t.rawTouch.identifier],delete this.ongoingTouches[e],t}_createTouch(e){return this._updateTouch(this.ongoingTouches.length,e)}getDomId(e){var t;return(t=this.ongoingTouches[e])==null?void 0:t.rawTouch.identifier}getTouchControllerId(e){var t;return(t=this.ongoingTouchesDOM[e])==null?void 0:t.id}_touchStartEvent(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];this.emit("start",this._createTouch(s))}}_touchEndEvent(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];this.emit("end",this._deleteTouch(this.getTouchControllerId(s.identifier)))}}_touchCancelEvent(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];this.emit("cancel",this._deleteTouch(this.getTouchControllerId(s.identifier)))}}_touchMoveEvent(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];this.emit("move",this._updateTouch(this.getTouchControllerId(s.identifier),s))}}}const Re=["jump","use","action1","action2","moveForwards","moveBackwards","moveLeft","moveRight","lookUp","lookDown","lookLeft","lookRight","pause","debug","fullscreen","zoom","changePerspective"],Tt={action1:"1",action2:"2",camera:"C",debug:"D",jump:"J",mouse:"M",moveBackwards:"v",moveForwards:"^",moveLeft:"<",moveRight:">",lookDown:"v",lookLeft:"<",lookRight:">",lookUp:"^",pause:"P",use:"E",fullscreen:"F",zoom:"Z",changePerspective:"P"};class kt extends te{constructor(e,t=window,s=document,i){super();this._element=e,this._window=t,this._document=s,this._game=i,this.touchController=new bt(this._element),this._cameraTouchId=null,this._mouseLocked=!1,this._inputs={mouse:{movement:new L,position:new L},camera:{movement:new L,position:new L}},this._assignmentToButtonCache=new ct({},!1),this._buttons={}}get element(){return this._element}get window(){return this._window}get document(){return this._document}get cameraTouchId(){return this._cameraTouchId}listen(){var e;this._setupEvents(),this.touchController.listen(),this.touchController.on("start",t=>{this._cameraTouchId===null&&(this._cameraTouchId=t.id),this._pointerLockChange(!0)}),this.touchController.on("stop",t=>{t.id===this._cameraTouchId&&(this._cameraTouchId=null)}),this.touchController.on("move",t=>{t.id===this._cameraTouchId&&(this._moveMouse(new L([t.movementX,t.movementY]).setMul(T.input.touch.mouseEmulation.sensitivity.multiplier).setPow(T.input.touch.mouseEmulation.sensitivity.power)),this._moveCamera(new L([t.movementX,t.movementY]).setMul(T.input.camera.touch.sensitivity.multiplier).setPow(T.input.camera.touch.sensitivity.power)))}),(e=this._game)==null||e.on("frameTick",t=>{const s=new L,i=T.input.camera.keyboard.sensitivity.multiplier*t;this.getInput("lookDown")&&s.setAdd([0,i]),this.getInput("lookUp")&&s.setAdd([0,-i]),this.getInput("lookRight")&&s.setAdd([i,0]),this.getInput("lookLeft")&&s.setAdd([-i,0]),this._moveCamera(s)})}_setupEvents(){this._element.addEventListener("mousedown",this._mouseDown.bind(this)),this._element.addEventListener("mouseup",this._mouseUp.bind(this)),this._window.addEventListener("keydown",this._keyDown.bind(this)),this._window.addEventListener("keyup",this._keyUp.bind(this)),this._element.addEventListener("contextmenu",this._contextMenu.bind(this)),this._window.addEventListener("blur",this._unfocus.bind(this)),this._window.addEventListener("mousemove",this._mouseMoveEvent.bind(this)),this._document.addEventListener("pointerlockchange",this._pointerLockChangeEvent.bind(this))}get mouseLocked(){return this._mouseLocked}_pointerLockChangeEvent(e){this._pointerLockChange()}_pointerLockChange(e=this.document.pointerLockElement===this._element){this._mouseLocked=e,this.emit("mouseLock",e)}get inputs(){return this._inputs}_mouseNumberToString(e){return`Mouse${e}`}_mouseDown(e){e.preventDefault(),this._buttonDown(this._mouseNumberToString(e.button))}_contextMenu(e){return e.preventDefault(),!1}_unfocus(){for(const e in this._inputs)Object.prototype.hasOwnProperty.call(this._inputs,e)&&Re.includes(e)&&this._processButtonInputEvent(e,!1)}_mouseUp(e){e.preventDefault(),this._buttonUp(this._mouseNumberToString(e.button))}_keyDown(e){e.preventDefault(),this._buttonDown(e.code)}_keyUp(e){e.preventDefault(),this._buttonUp(e.code)}_buttonDown(e){this._processButtonEvent(e,!0)}_buttonUp(e){this._processButtonEvent(e,!1)}_processButtonInputEvent(e,t,s=T.input[e]){const i={button:s,mapped:e};t===!0?this.emit("buttonDown",i):this.emit("buttonUp",i),e!=="none"&&(this._inputs[e]=t,this.emit(e,t))}_getButtonInputFromButton(e){return this._assignmentToButtonCache.do(e,()=>{const t=T.input.keys;for(const s in t)if(Object.prototype.hasOwnProperty.call(t,s)&&t[s]===e)return s;return"none"})}_processButtonEvent(e,t){if(this._buttons[e]===t)return;this._buttons[e]=t;const s=this._getButtonInputFromButton(e);this._processButtonInputEvent(s,t,e)}_mouseMoveEvent(e){this._mouseMove(new L([e.movementX,e.movementY]),new L([e.clientX,e.clientY]))}_mouseMove(e,t){this._moveMouse(e,t),this._moveCamera(this._inputs.mouse.movement.setMul(T.input.camera.mouse.sensitivity.multiplier).setPow(T.input.camera.mouse.sensitivity.power)),this.emit("mouse",this._inputs.mouse)}_moveMouse(e,t){this._inputs.mouse.movement.set(e),t?this._inputs.mouse.position.set(t):this._inputs.mouse.position.add(e)}_moveCamera(e){this._mouseLocked&&(this._inputs.camera.movement.set(e),this._inputs.camera.position.setAdd(e),this.emit("camera",this._inputs.camera))}lockPointer(){this._element.requestPointerLock()}unlockPointer(){this._document.exitPointerLock()}getButtonDown(e){return this._buttons[e]===!0}getInput(e){const t=this._inputs[e];return t===void 0?!1:t}_removeEvents(){}}class xt{constructor(e,t,s,i){this._canvas=e,this._game=t,this._assets=s,this._room=i,this._canvasContext=this._canvas.getContext("webgl"),this.camera=new wt,this._resolution=1,this._info={triangles:0},this._room.world.add(this.camera)}set resolution(e){this._resolution=e,this.updateSize()}get resolution(){return this._resolution}setupRenderer(){E("dbug","setting up renderer..."),this._renderer=new $e({context:this._canvasContext,antialias:!1}),E("dbug","done setting up renderer.")}get info(){return this._info}_updateShadowMap(){this._renderer.shadowMap.needsUpdate=!0}async start(){return this.setupRenderer(),this.updateSize(),this._room.world.rendererObject.background=new et(0),he(e=>{this._renderer.shadowMap.enabled=e.video.shadows.enabled,e.video.shadows.reduceShadowUpdates===!0&&(this._renderer.shadowMap.autoUpdate=!1),this.updateSize()}),this._game.on("fixedTick",this._fixedTick.bind(this)),this._game.on("frameTick",this._frameTick.bind(this)),this}_frameTick(){this._renderer.render(this._room.world.rendererObject,this.camera.rendererObject),this._info.triangles=this._renderer.info.render.triangles}_fixedTick(){this._renderer.shadowMap.autoUpdate&&this._updateShadowMap()}updateSize(){this._renderer.info.reset();const e=innerWidth*this._resolution,t=innerHeight*this._resolution;return this._canvas.width=e,this._canvas.height=t,this._renderer.setSize(e,t),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this}}class St{constructor(e){this._assetsInput=e,this.assets={models:{},images:{}}}async loadAssets(e){await this._loadAssets(e)}async _loadAssets(e){E("dbug","loading assets...");function t(a,l){let _=0,h=0;for(const m of s)m.loaded>m.total?(_+=m.total,E("warn",`an asset's amount loaded is more than its total! (${m.loaded}/${m.total})`)):_+=m.loaded,h+=m.total;e==null||e(_,h,"Downloading assets",`${l} ${a}`)}const s=[],i=this._assetsInput.models;for(const a in i)if(Object.prototype.hasOwnProperty.call(i,a)){const l=i[a],_=tt.extname(l);let h;switch(_){case".gltf":h=it;break;case".json":h=st;break}if(h!==void 0){const m=new h,g={promise:async()=>{const c=await m.loadAsync(l,o=>{g.loaded=o.loaded,g.total=o.total,t("model",_)});return B.rendererObjectToJSON(c)},loaded:0,total:0};typeof g.promise=="function"&&(g.promise=g.promise()),g.promise.then(c=>{this.assets.models[a]=c}),s.push(g)}else{const m=new Error(`Unknown file type: ${a}${_} `);throw E("err!",m.message),m}}const r=s.map(a=>a.promise);await Promise.all(r),E("dbug","done loading assets",this.assets)}}class yt{constructor(){this.world=new vt}}function Ae(n,e,t){const s=n.slice();return s[7]=e[t],s}function je(n,e,t){const s=n.slice();return s[10]=e[t],s[12]=t,s}function Oe(n){let e,t,s,i,r,a,l,_=n[1],h=[];for(let o=0;o<_.length;o+=1)h[o]=ze(je(n,_,o));const m=o=>z(h[o],1,1,()=>{h[o]=null});let g=n[0]?n[3]:n[4],c=[];for(let o=0;o<g.length;o+=1)c[o]=Be(Ae(n,g,o));return{c(){e=S("div"),t=S("div");for(let o=0;o<h.length;o+=1)h[o].c();s=A(),i=S("div");for(let o=0;o<c.length;o+=1)c[o].c();this.h()},l(o){e=y(o,"DIV",{class:!0});var u=M(e);t=y(u,"DIV",{class:!0});var d=M(t);for(let w=0;w<h.length;w+=1)h[w].l(d);d.forEach(f),s=j(u),i=y(u,"DIV",{class:!0});var v=M(i);for(let w=0;w<c.length;w+=1)c[w].l(v);v.forEach(f),u.forEach(f),this.h()},h(){k(t,"class","panels svelte-1xg1opo"),k(i,"class","text svelte-1xg1opo"),k(e,"class",r="container "+(n[0]?"":"hidden")+" svelte-1xg1opo")},m(o,u){R(o,e,u),b(e,t);for(let d=0;d<h.length;d+=1)h[d].m(t,null);b(e,s),b(e,i);for(let d=0;d<c.length;d+=1)c[d].m(i,null);l=!0},p(o,u){if(n=o,u&3){_=n[1];let d;for(d=0;d<_.length;d+=1){const v=je(n,_,d);h[d]?(h[d].p(v,u),P(h[d],1)):(h[d]=ze(v),h[d].c(),P(h[d],1),h[d].m(t,null))}for(ve(),d=_.length;d<h.length;d+=1)m(d);be()}if(u&25){g=n[0]?n[3]:n[4];let d;for(d=0;d<g.length;d+=1){const v=Ae(n,g,d);c[d]?c[d].p(v,u):(c[d]=Be(v),c[d].c(),c[d].m(i,null))}for(;d<c.length;d+=1)c[d].d(1);c.length=g.length}(!l||u&1&&r!==(r="container "+(n[0]?"":"hidden")+" svelte-1xg1opo"))&&k(e,"class",r)},i(o){if(!l){for(let u=0;u<_.length;u+=1)P(h[u]);ot(()=>{a||(a=Te(e,ye,{duration:200,easing:Se},!0)),a.run(1)}),l=!0}},o(o){h=h.filter(Boolean);for(let u=0;u<h.length;u+=1)z(h[u]);a||(a=Te(e,ye,{duration:200,easing:Se},!1)),a.run(0),l=!1},d(o){o&&f(e),ke(h,o),ke(c,o),o&&a&&a.end()}}}function ze(n){let e,t,s,i,r,a;return t=new gt({props:{panel:n[10],compact:!n[0]}}),{c(){e=S("div"),K(t.$$.fragment),s=A(),this.h()},l(l){e=y(l,"DIV",{class:!0});var _=M(e);Q(t.$$.fragment,_),s=j(_),_.forEach(f),this.h()},h(){k(e,"class","panel "+(n[12]===0?"top":"")+" svelte-1xg1opo")},m(l,_){R(l,e,_),$(t,e,null),b(e,s),i=!0,r||(a=nt(e,"click",n[6]),r=!0)},p(l,_){const h={};_&2&&(h.panel=l[10]),_&1&&(h.compact=!l[0]),t.$set(h)},i(l){i||(P(t.$$.fragment,l),i=!0)},o(l){z(t.$$.fragment,l),i=!1},d(l){l&&f(e),ee(t),r=!1,a()}}}function Be(n){let e,t=n[7]+"",s;return{c(){e=S("span"),s=q(t),this.h()},l(i){e=y(i,"SPAN",{class:!0});var r=M(e);s=J(r,t),r.forEach(f),this.h()},h(){k(e,"class","line svelte-1xg1opo")},m(i,r){R(i,e,r),b(e,s)},p(i,r){r&25&&t!==(t=i[7]+"")&&ae(s,t)},d(i){i&&f(e)}}}function Mt(n){let e,t,s=n[2]&&Oe(n);return{c(){s&&s.c(),e=xe()},l(i){s&&s.l(i),e=xe()},m(i,r){s&&s.m(i,r),R(i,e,r),t=!0},p(i,[r]){i[2]?s?(s.p(i,r),r&4&&P(s,1)):(s=Oe(i),s.c(),P(s,1),s.m(e.parentNode,e)):s&&(ve(),z(s,1,1,()=>{s=null}),be())},i(i){t||(P(s),t=!0)},o(i){z(s),t=!1},d(i){s&&s.d(i),i&&f(e)}}}function Et(n,e,t){let{open:s=!1}=e,{active:i=!1}=e,{panels:r=[]}=e,{text:a=[]}=e,{textClosed:l=[]}=e;function _(m){t(1,r=[...r,m])}const h=m=>{m.preventDefault(),t(0,s=!s)};return n.$$set=m=>{"open"in m&&t(0,s=m.open),"active"in m&&t(2,i=m.active),"panels"in m&&t(1,r=m.panels),"text"in m&&t(3,a=m.text),"textClosed"in m&&t(4,l=m.textClosed)},[s,r,i,a,l,_,h]}class Dt extends X{constructor(e){super();G(this,e,Et,Mt,H,{open:0,active:2,panels:1,text:3,textClosed:4,addPanel:5})}get addPanel(){return this.$$.ctx[5]}}class Ue extends se{constructor(...e){super(...e);this._lowestThisSection=1/0,this._highestThisSection=0,this._TPSTicker=new U({method:F.Manual,rate:1e3}),this.showExtras=!0,this._updateText=!1,this._TPSTicker.start(),this.on("update",(t,s,i)=>{this._lowestThisSection>i?this._lowestThisSection=i:this._highestThisSection<i&&(this._highestThisSection=i),this._TPSTicker.manualCallback()}),this._TPSTicker.on("tick",()=>this.updateText())}updateText(){this.text="";function e(s){return typeof s=="number"?Math.floor(s):s}const t=`${e(this._lowestThisSection)}/${e(this._highestThisSection)}`;this.compactText=`${t} ${this.unit}`,this.text=`${t} ${this.unit}
(${e(this._min)} - ${e(this._max)})`,this._lowestThisSection=1/0,this._highestThisSection=0}}function Pt(n){let e,t,s,i,r,a,l,_,h;i=new ut({props:{show:n[4],info:n[2],percent:n[3],title:n[1],error:n[5],logs:n[6],showLogs:Lt,suggestLogs:n[7]}});function m(o){n[16](o)}function g(o){n[17](o)}let c={text:n[11],textClosed:n[12]};return n[10]!==void 0&&(c.open=n[10]),n[9]!==void 0&&(c.active=n[9]),a=new Dt({props:c}),n[15](a),V.push(()=>Me(a,"open",m)),V.push(()=>Me(a,"active",g)),{c(){e=S("main"),t=S("canvas"),s=A(),K(i.$$.fragment),r=A(),K(a.$$.fragment),this.h()},l(o){e=y(o,"MAIN",{class:!0});var u=M(e);t=y(u,"CANVAS",{id:!0,class:!0}),M(t).forEach(f),s=j(u),Q(i.$$.fragment,u),r=j(u),Q(a.$$.fragment,u),u.forEach(f),this.h()},h(){k(t,"id","canvas"),k(t,"class","svelte-1nlk8s4"),k(e,"class","svelte-1nlk8s4"),Z(e,"noSelect",n[13])},m(o,u){R(o,e,u),b(e,t),n[14](t),b(e,s),$(i,e,null),b(e,r),$(a,e,null),h=!0},p(o,[u]){const d={};u&16&&(d.show=o[4]),u&4&&(d.info=o[2]),u&8&&(d.percent=o[3]),u&2&&(d.title=o[1]),u&32&&(d.error=o[5]),u&64&&(d.logs=o[6]),u&128&&(d.suggestLogs=o[7]),i.$set(d);const v={};u&2048&&(v.text=o[11]),u&4096&&(v.textClosed=o[12]),!l&&u&1024&&(l=!0,v.open=o[10],Ee(()=>l=!1)),!_&&u&512&&(_=!0,v.active=o[9],Ee(()=>_=!1)),a.$set(v),u&8192&&Z(e,"noSelect",o[13])},i(o){h||(P(i.$$.fragment,o),P(a.$$.fragment,o),h=!0)},o(o){z(i.$$.fragment,o),z(a.$$.fragment,o),h=!1},d(o){o&&f(e),n[14](null),ee(i),n[15](null),ee(a)}}}let Lt=!0;function Ct(n,e,t){fe(()=>{});let s,i="Downloading webpage",r="",a=0,l=!0,_=!0,h=!1,m=[],g=!0,c,o=!1,u=!1,d=[],v=[];pe(()=>{(async()=>{he(p=>{switch(p.debug.stats.show){case le.No:t(9,o=!1),t(10,u=!1);break;case le.Collapsed:t(9,o=!0),t(10,u=!1);break;case le.Open:t(9,o=!0),t(10,u=!0);break}t(13,w=p.video.noSelect),t(7,g=p.debug.logging.hideLoadingLogs)});const x=new Ue("Frame TPS","#0FF","#022"),ue=new Ue("Fixed TPS","#FF0","#220"),D=new se("Memory","#F0F","#202"),ie=new se("Things","#0F0","#020"),ne=new se("Triangles","#0FF","#022");c.addPanel(x),c.addPanel(ue),c.addPanel(D),c.addPanel(ie),c.addPanel(ne),D.unit="MB",x.dynamicMax=!0,ie.dynamicMax=!0,ne.dynamicMax=!0;function de(p){return Math.floor(1e3/p)}function Ve(){if(performance.memory){D.update(performance.memory.usedJSHeapSize*1e-6),D.showExtras=!0;const p=performance.memory.usedJSHeapSize/performance.memory.jsHeapSizeLimit;D.dynamicMax=!0,D.unstable=p>.5,D.unstableText=`${Math.floor(p*100)}% usage`}else D.update(`???
No memory
support`),D.dynamicMax=!1,D.showExtras=!1}function _e(p,I,W,oe){p.update(de(W),oe),p.unstable=I!==W,p.unstableText=`faking ${de(I)}TPS`}const C=new ft(s);function me(p){t(6,m=[...m,p])}Le.on("outputNotLeveled",me.bind(this)),C.on("started",()=>{_!==!1&&(t(4,l=!1),t(1,i="Done"),t(2,r=""),_=!1)});function ge(p,I,W,oe){_!==!1&&(t(3,a=p/I),t(1,i=W),t(2,r=oe),E("dbug","loading update: "+i+((r!=null?r:!1)?` (${r})`:"")+` ${Math.floor(a*100)}%`))}try{await C.load(ge.bind(this)),await C.start(ge.bind(this))}catch(p){t(1,i="Failed"),t(2,r=`${p}`),_=!1,t(5,h=!0),E("err!","error loading/starting game:",p),t(7,g=!1);return}Le.off("output",me.bind(this)),C.frameTicker.on("tick",(p,I)=>{_e(x,p,I),t(11,d=C.debugText),t(12,v=C.debugTextShort)}),C.fixedTicker.on("tick",(p,I)=>{_e(ue,p,I,20),Ve(),ie.update(B.count),ne.update(C.rendering.info.triangles)})})()});let w=!1;function N(x){V[x?"unshift":"push"](()=>{s=x,t(0,s)})}function ce(x){V[x?"unshift":"push"](()=>{c=x,t(8,c)})}function Fe(x){u=x,t(10,u)}function Ne(x){o=x,t(9,o)}return[s,i,r,a,l,h,m,g,c,o,u,d,v,w,N,ce,Fe,Ne]}class It extends X{constructor(e){super();G(this,e,Ct,Pt,H,{})}}function Rt(n){let e,t,s;return t=new It({}),{c(){e=A(),K(t.$$.fragment),this.h()},l(i){at('[data-svelte="svelte-4vcxiu"]',document.head).forEach(f),e=j(i),Q(t.$$.fragment,i),this.h()},h(){document.title="..."},m(i,r){R(i,e,r),$(t,i,r),s=!0},p:re,i(i){s||(P(t.$$.fragment,i),s=!0)},o(i){z(t.$$.fragment,i),s=!1},d(i){i&&f(e),ee(t,i)}}}class Ot extends X{constructor(e){super();G(this,e,null,Rt,H,{})}}export{Ot as default};
